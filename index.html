<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>report</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="report_files/libs/clipboard/clipboard.min.js"></script>
<script src="report_files/libs/quarto-html/quarto.js"></script>
<script src="report_files/libs/quarto-html/popper.min.js"></script>
<script src="report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="report_files/libs/quarto-html/anchor.min.js"></script>
<link href="report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="report_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="report_files/libs/bootstrap/bootstrap-ddb8c80b4dfc441076cb8508978e521e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="custom.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">V.I.E BNP RMIR - Madrid</h2>
   
  <ul>
  <li><a href="#exercise-1-model-calibration-exercise" id="toc-exercise-1-model-calibration-exercise" class="nav-link active" data-scroll-target="#exercise-1-model-calibration-exercise">EXERCISE 1/ Model calibration exercise </a><a class="anchor nav-link" id="chapter1" data-scroll-target="undefined" href=""></a>
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup </a><a class="anchor nav-link" id="section_1_1" data-scroll-target="undefined" href=""></a>
  <ul>
  <li><a href="#evaluation-date" id="toc-evaluation-date" class="nav-link" data-scroll-target="#evaluation-date">Evaluation date </a><a class="anchor nav-link" id="section_1_1_1" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#yield-curve" id="toc-yield-curve" class="nav-link" data-scroll-target="#yield-curve">Yield curve </a><a class="anchor nav-link" id="section_1_1_2" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#market-data" id="toc-market-data" class="nav-link" data-scroll-target="#market-data">Market data </a><a class="anchor nav-link" id="section_1_1_3" data-scroll-target="undefined" href=""></a></li>
  </ul></li>
  <li><a href="#calibration" id="toc-calibration" class="nav-link" data-scroll-target="#calibration">Calibration </a><a class="anchor nav-link" id="section_1_2" data-scroll-target="undefined" href=""></a>
  <ul>
  <li><a href="#swaptionhelper" id="toc-swaptionhelper" class="nav-link" data-scroll-target="#swaptionhelper">SwaptionHelper </a><a class="anchor nav-link" id="section_1_2_1" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#swaptionengine" id="toc-swaptionengine" class="nav-link" data-scroll-target="#swaptionengine">SwaptionEngine </a><a class="anchor nav-link" id="section_1_2_2" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization">Optimization </a><a class="anchor nav-link" id="section_1_2_3" data-scroll-target="undefined" href=""></a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results </a><a class="anchor nav-link" id="section_1_3" data-scroll-target="undefined" href=""></a>
  <ul>
  <li><a href="#calibrated-parameters" id="toc-calibrated-parameters" class="nav-link" data-scroll-target="#calibrated-parameters">Calibrated Parameters </a><a class="anchor nav-link" id="section_1_3_1" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#table-4.3.-g2-calibrated-swaptions-volatilities" id="toc-table-4.3.-g2-calibrated-swaptions-volatilities" class="nav-link" data-scroll-target="#table-4.3.-g2-calibrated-swaptions-volatilities">Table 4.3. G2++ calibrated swaptions volatilities </a><a class="anchor nav-link" id="section_1_3_2" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#table-4.4.-swaptions-calibration-results-percentage-differences" id="toc-table-4.4.-swaptions-calibration-results-percentage-differences" class="nav-link" data-scroll-target="#table-4.4.-swaptions-calibration-results-percentage-differences">Table 4.4. Swaptions calibration results: percentage differences </a><a class="anchor nav-link" id="section_1_3_3" data-scroll-target="undefined" href=""></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#exercise-2-assessment-of-calibration-uncertainty" id="toc-exercise-2-assessment-of-calibration-uncertainty" class="nav-link" data-scroll-target="#exercise-2-assessment-of-calibration-uncertainty">EXERCISE 2/ Assessment of calibration uncertainty </a><a class="anchor nav-link" id="chapter2" data-scroll-target="undefined" href=""></a>
  <ul>
  <li><a href="#the-black-karasinski-model" id="toc-the-black-karasinski-model" class="nav-link" data-scroll-target="#the-black-karasinski-model">The Black-Karasinski model </a><a class="anchor nav-link" id="section_2_0" data-scroll-target="undefined" href=""></a>
  <ul>
  <li><a href="#the-need-of-a-new-model" id="toc-the-need-of-a-new-model" class="nav-link" data-scroll-target="#the-need-of-a-new-model">The need of a new model </a><a class="anchor nav-link" id="section_2_0_00" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions </a><a class="anchor nav-link" id="section_2_0_1" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#log-normality" id="toc-log-normality" class="nav-link" data-scroll-target="#log-normality">Log normality </a><a class="anchor nav-link" id="section_2_0_2" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#mean-reversion" id="toc-mean-reversion" class="nav-link" data-scroll-target="#mean-reversion">Mean reversion </a><a class="anchor nav-link" id="section_2_0_3" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#drawbacks" id="toc-drawbacks" class="nav-link" data-scroll-target="#drawbacks">Drawbacks </a><a class="anchor nav-link" id="section_2_0_4" data-scroll-target="undefined" href=""></a></li>
  </ul></li>
  <li><a href="#a-few-theoretical-results-before-to-start-exercise-2" id="toc-a-few-theoretical-results-before-to-start-exercise-2" class="nav-link" data-scroll-target="#a-few-theoretical-results-before-to-start-exercise-2">A few theoretical results before to start exercise 2</a><a class="anchor nav-link" id="section_2_0_5" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section">1. </a><a class="anchor nav-link" id="section_2_1" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1">2. </a><a class="anchor nav-link" id="section_2_2" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2">3. </a><a class="anchor nav-link" id="section_2_3" data-scroll-target="undefined" href=""></a></li>
  <li><a href="#section-3" id="toc-section-3" class="nav-link" data-scroll-target="#section-3">4. </a><a class="anchor nav-link" id="section_2_4" data-scroll-target="undefined" href=""></a></li>
  </ul></li>
  <li><a href="#appendix---the-quantlib-g2-class" id="toc-appendix---the-quantlib-g2-class" class="nav-link" data-scroll-target="#appendix---the-quantlib-g2-class">Appendix - The QuantLib <code>G2</code> class</a>
  <ul>
  <li><a href="#the-g2.hpp-file" id="toc-the-g2.hpp-file" class="nav-link" data-scroll-target="#the-g2.hpp-file">The <code>g2.hpp</code> file</a></li>
  <li><a href="#the-g2.cpp-file" id="toc-the-g2.cpp-file" class="nav-link" data-scroll-target="#the-g2.cpp-file">The <code>g2.cpp</code> file</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">




<h1 style="text-align: center;">
V.I.E BNP RMIR - Madrid
</h1>
<h2 style="text-align: center;" class="anchored">
Assignments
</h2>
<center>
Victor DUC
</center>
<center>
February 10, 2025
</center>
<p><br></p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import necessary libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> QuantLib <span class="im">as</span> ql</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exercise-1-model-calibration-exercise" class="level1">
<h1>EXERCISE 1/ Model calibration exercise <a class="anchor" id="chapter1" href=""></a></h1>
<hr>
<p>The functionality of the QuantLib <code>G2</code> class is explained in the appendix.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup <a class="anchor" id="section_1_1" href=""></a></h2>
<section id="evaluation-date" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-date">Evaluation date <a class="anchor" id="section_1_1_1" href=""></a></h3>
<p>Let’s start by setting the evaluation date in <code>QuantLib</code> to <strong>February 13, 2001</strong>, ensuring that all market data, discounting, and instrument pricing are aligned with that specific historical context. Without this step, <code>QuantLib</code> would default to the current system date.</p>
<div id="cell-9" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a QuantLib date object representing February 13, 2001</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>todays_date <span class="op">=</span> ql.Date(<span class="dv">13</span>, <span class="dv">2</span>, <span class="dv">2001</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the global evaluation date in QuantLib</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ql.Settings.instance().evaluationDate <span class="op">=</span> todays_date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="yield-curve" class="level3">
<h3 class="anchored" data-anchor-id="yield-curve">Yield curve <a class="anchor" id="section_1_1_2" href=""></a></h3>
<p>We define a flat 5% yield curve to provide the necessary term structure input for the G2++ model. The yield curve is necessary to anchor the model to the current term structure for computing discount factors and forward rates.</p>
<div id="cell-12" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a QuantLib SimpleQuote object to store a constant interest rate of 5%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>rate <span class="op">=</span> ql.SimpleQuote(<span class="fl">0.05</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a QuantLib QuoteHandle to manage and reference the SimpleQuote object</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>rate_handle <span class="op">=</span> ql.QuoteHandle(rate)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the day count convention as Actual/360</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>day_count <span class="op">=</span> ql.Actual360()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a QuantLib FlatForward yield curve</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>flat_forward_curve <span class="op">=</span> ql.FlatForward(todays_date, rate_handle, day_count)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a YieldTermStructureHandle to manage and reference the flat forward yield curve</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>term_structure <span class="op">=</span> ql.YieldTermStructureHandle(flat_forward_curve)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="market-data" class="level3">
<h3 class="anchored" data-anchor-id="market-data">Market data <a class="anchor" id="section_1_1_3" href=""></a></h3>
<p>Now, we need to implement the market data from <strong>Table 4.2. At-the-money Euro swaption-volatility quotes on February 13, 2001, at 5 p.m.</strong> in the <a href="https://link.springer.com/book/10.1007/978-3-540-34604-3">Brigo-Mercurio</a> book.</p>
<div id="cell-15" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of QuantLib Period objects representing swaption maturities T</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>swaption_maturities <span class="op">=</span> [ql.Period(i, ql.Years) <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">10</span>]]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of QuantLib Period objects representing tenors t_n - t_0</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>swap_tenors <span class="op">=</span> [ql.Period(i, ql.Years) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a numpy array to store market swaption volatility data for different maturities and tenors</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>market_vols <span class="op">=</span> np.array([</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1640</span>, <span class="fl">0.1550</span>, <span class="fl">0.1430</span>, <span class="fl">0.1310</span>, <span class="fl">0.1240</span>, <span class="fl">0.1190</span>, <span class="fl">0.1160</span>, <span class="fl">0.1120</span>, <span class="fl">0.1100</span>, <span class="fl">0.1070</span>],</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1600</span>, <span class="fl">0.1500</span>, <span class="fl">0.1390</span>, <span class="fl">0.1290</span>, <span class="fl">0.1220</span>, <span class="fl">0.1190</span>, <span class="fl">0.1160</span>, <span class="fl">0.1130</span>, <span class="fl">0.1100</span>, <span class="fl">0.1080</span>],</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1570</span>, <span class="fl">0.1450</span>, <span class="fl">0.1340</span>, <span class="fl">0.1240</span>, <span class="fl">0.1190</span>, <span class="fl">0.1150</span>, <span class="fl">0.1130</span>, <span class="fl">0.1100</span>, <span class="fl">0.1080</span>, <span class="fl">0.1060</span>],</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1480</span>, <span class="fl">0.1360</span>, <span class="fl">0.1260</span>, <span class="fl">0.1190</span>, <span class="fl">0.1140</span>, <span class="fl">0.1120</span>, <span class="fl">0.1090</span>, <span class="fl">0.1070</span>, <span class="fl">0.1050</span>, <span class="fl">0.1030</span>],</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1400</span>, <span class="fl">0.1280</span>, <span class="fl">0.1210</span>, <span class="fl">0.1140</span>, <span class="fl">0.1100</span>, <span class="fl">0.1070</span>, <span class="fl">0.1050</span>, <span class="fl">0.1030</span>, <span class="fl">0.1020</span>, <span class="fl">0.1000</span>],</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1300</span>, <span class="fl">0.1190</span>, <span class="fl">0.1130</span>, <span class="fl">0.1050</span>, <span class="fl">0.1010</span>, <span class="fl">0.0990</span>, <span class="fl">0.0970</span>, <span class="fl">0.0960</span>, <span class="fl">0.0950</span>, <span class="fl">0.0930</span>],</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1160</span>, <span class="fl">0.1070</span>, <span class="fl">0.1000</span>, <span class="fl">0.0930</span>, <span class="fl">0.0900</span>, <span class="fl">0.0890</span>, <span class="fl">0.0870</span>, <span class="fl">0.0860</span>, <span class="fl">0.0850</span>, <span class="fl">0.0840</span>]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="report_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="calibration" class="level2">
<h2 class="anchored" data-anchor-id="calibration">Calibration <a class="anchor" id="section_1_2" href=""></a></h2>
<section id="swaptionhelper" class="level3">
<h3 class="anchored" data-anchor-id="swaptionhelper">SwaptionHelper <a class="anchor" id="section_1_2_1" href=""></a></h3>
<p>Let’s iterate through the market data to create a <code>SwaptionHelper</code> for each combination of maturity and tenor, which we store in a list. A <code>SwaptionHelper</code> in <code>QuantLib</code> is a calibration tool that links market swaption quotes (volatility, expiry, tenor) to a pricing model, enabling parameter optimization by matching model-generated swaption prices to observed market prices.</p>
<div id="cell-20" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>swaption_helpers <span class="op">=</span> []</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over each combination of swaption maturities and tenors</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, maturity <span class="kw">in</span> <span class="bu">enumerate</span>(swaption_maturities):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j, tenor <span class="kw">in</span> <span class="bu">enumerate</span>(swap_tenors):</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a QuoteHandle for the market volatility value at the given maturity and tenor</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        vol_handle <span class="op">=</span> ql.QuoteHandle(ql.SimpleQuote(market_vols[i, j]))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a SwaptionHelper object to model a swaption with specified parameters</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        helper <span class="op">=</span> ql.SwaptionHelper(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            maturity, tenor, vol_handle,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>            ql.Euribor6M(term_structure),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            ql.Period(<span class="dv">1</span>, ql.Years),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            day_count, day_count,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            term_structure, ql.BlackCalibrationHelper.RelativePriceError</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        swaption_helpers.append(helper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is now time to instantiate the model using the <code>G2</code> class as outlined in the appendix of the report.</p>
<div id="cell-22" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate the G2++ model using the default parameter values for a, sigma, b, eta, and rho</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>g2_model <span class="op">=</span> ql.G2(term_structure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="swaptionengine" class="level3">
<h3 class="anchored" data-anchor-id="swaptionengine">SwaptionEngine <a class="anchor" id="section_1_2_2" href=""></a></h3>
<p>The following line of code sets up the pricing engine for the G2++ swaption model, where the model’s parameters and equations are embedded. Specifically, the <code>g2_model</code> object contains the G2++ model that describes the evolution of interest rates, and the engine utilizes this model to calculate swaption prices. By specifying the range (<code>1.0</code>) and the number of intervals (<code>1000</code>), this line effectively configures the numerical integration of the pricing formula, ensuring that the model accounts for the necessary standard deviations and provides an accurate approximation of the swaption’s value based on the G2++ model’s dynamics.</p>
<div id="cell-25" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a G2SwaptionEngine with the given G2 model, time step of 1.0, and 1000 discretization intervals for calibration</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> ql.G2SwaptionEngine(g2_model, <span class="fl">1.0</span>, <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now have to loop through <code>swaption_helpers</code> and set each helper’s pricing engine to the <code>G2SwaptionEngine</code> for calculating swaption prices.</p>
<div id="cell-27" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the pricing engine for each swaption helper in the list to the G2++ swaption engine</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> helper <span class="kw">in</span> swaption_helpers:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    helper.setPricingEngine(engine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optimization" class="level3">
<h3 class="anchored" data-anchor-id="optimization">Optimization <a class="anchor" id="section_1_2_3" href=""></a></h3>
<p>Eventually, we calibrate the G2++ model using the Levenberg-Marquardt optimization method and specified end criteria on the swaption helpers.</p>
<div id="cell-30" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration of the G2++ model using Levenberg-Marquardt method with specified end criteria</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>optimization_method <span class="op">=</span> ql.LevenbergMarquardt()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicit stopping criteria:</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>end_criteria <span class="op">=</span> ql.EndCriteria(<span class="dv">1000</span>, <span class="dv">500</span>, <span class="fl">1e-6</span>, <span class="fl">1e-6</span>, <span class="fl">1e-6</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># end_criteria = ql.EndCriteria(</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     maxIterations=1000,       # Maximum number of iterations</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     maxStationaryStateIterations=500, # Iterations without improvement</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     rootEpsilon=1e-6,         # Tolerance on parameters</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     functionEpsilon=1e-6,     # Tolerance on the cost function</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     gradientNormEpsilon=1e-6  # Tolerance on the gradient</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the calibration with tracking</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>g2_model.calibrate(swaption_helpers, optimization_method, end_criteria)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s focus on the convergence of the method.</p>
<div id="cell-32" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(g2_model.endCriteria())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
</div>
<p>According to the file <a href="https://github.com/lballabio/QuantLib/blob/master/ql/math/optimization/endcriteria.hpp"><code>ql/math/optimization/endcriteria.hpp</code></a> :</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Type <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    None<span class="op">,</span>                         <span class="co">// 0</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    MaxIterations<span class="op">,</span>                <span class="co">// 1</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    StationaryPoint<span class="op">,</span>              <span class="co">// 2</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    StationaryFunctionValue<span class="op">,</span>      <span class="co">// 3</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    StationaryFunctionAccuracy<span class="op">,</span>   <span class="co">// 4</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    ZeroGradientNorm<span class="op">,</span>             <span class="co">// 5</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    FunctionEpsilonTooSmall<span class="op">,</span>      <span class="co">// 6</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    Unknown                       <span class="co">// 7</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and the file <a href="https://github.com/lballabio/QuantLib/blob/master/ql/math/optimization/endcriteria.cpp#L79"><code>ql/math/optimization/endcriteria.cpp</code></a></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> EndCriteria<span class="op">::</span>checkStationaryFunctionValue<span class="op">(</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">const</span> Real fxOld<span class="op">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">const</span> Real fxNew<span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                            Size<span class="op">&amp;</span> statStateIterations<span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                                            EndCriteria<span class="op">::</span>Type<span class="op">&amp;</span> ecType<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>fabs<span class="op">(</span>fxNew<span class="op">-</span>fxOld<span class="op">)</span> <span class="op">&gt;=</span> <span class="va">functionEpsilon_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>            statStateIterations <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">++</span>statStateIterations<span class="op">;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>statStateIterations <span class="op">&lt;=</span> <span class="va">maxStationaryStateIterations_</span><span class="op">)</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        ecType <span class="op">=</span> StationaryFunctionValue<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A return of 3 (<code>StationaryFunctionValue</code>) means that the algorithm stopped because the change in the objective function (the cost) between two iterations became smaller than the <code>functionEpsilon</code> threshold of <span class="math inline">\(1e-6\)</span>. It indicates that the algorithm has converged to a local minimum.</p>
<blockquote class="blockquote">
<p>I haven’t found a direct way in <code>QuantLib</code> to access the number of iterations of the method or the evolution of the objective function</p>
</blockquote>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results <a class="anchor" id="section_1_3" href=""></a></h2>
<section id="calibrated-parameters" class="level3">
<h3 class="anchored" data-anchor-id="calibrated-parameters">Calibrated Parameters <a class="anchor" id="section_1_3_1" href=""></a></h3>
<p>Let’s take a look at the obtained parameters.</p>
<div id="cell-37" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> g2_model.params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell" data-execution_count="14">
<div class="cell-output cell-output-display cell-output-markdown">
<span class="math display">\[\begin{array}{cc}
\begin{array}{|c|c|} \hline
\textbf{Parameter} &amp; \textbf{Calibrated Value} \\ \hline
a &amp; 11.417883267 \\ \hline
b &amp; 0.862582670 \\ \hline
\sigma &amp; 0.086663458 \\ \hline
\eta &amp; 0.012178218 \\ \hline
\rho &amp; -0.772255479 \\ \hline
\end{array}
&amp; \quad
\begin{array}{|c|c|} \hline
\textbf{Parameter} &amp; \textbf{Calibrated Value} \\ \hline
a &amp; 0.773511777 \\ \hline
b &amp; 0.082013014 \\ \hline
\sigma &amp; 0.022284644 \\ \hline
\eta &amp; 0.010382461 \\ \hline
\rho &amp; -0.701985206 \\ \hline
\end{array}
\end{array}\]</span>
<p><span class="math display">\[\textbf{Table.} \text{ Calibrated Values (My values on the left, Brigo-Mercurio values on the right)}\]</span></p>
</div>
</div>
</section>
<section id="table-4.3.-g2-calibrated-swaptions-volatilities" class="level3">
<h3 class="anchored" data-anchor-id="table-4.3.-g2-calibrated-swaptions-volatilities">Table 4.3. G2++ calibrated swaptions volatilities <a class="anchor" id="section_1_3_2" href=""></a></h3>
<div id="cell-40" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an array to store the adjusted volatilities</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>fitted_vols <span class="op">=</span> np.zeros((<span class="bu">len</span>(swaption_maturities), <span class="bu">len</span>(swap_tenors)))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the adjusted volatilities using the G2++ model</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, maturity <span class="kw">in</span> <span class="bu">enumerate</span>(swaption_maturities):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j, tenor <span class="kw">in</span> <span class="bu">enumerate</span>(swap_tenors):</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        helper <span class="op">=</span> swaption_helpers[i <span class="op">*</span> <span class="bu">len</span>(swap_tenors) <span class="op">+</span> j]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the swaption price using the calibrated G2++ model</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        model_price <span class="op">=</span> helper.modelValue()</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the corresponding implied volatility</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        fitted_vols[i, j] <span class="op">=</span> helper.impliedVolatility(</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>            model_price, <span class="fl">1e-6</span>, <span class="dv">100</span>, <span class="fl">0.05</span>, <span class="fl">1.0</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell" data-execution_count="16">
<div class="cell-output cell-output-display cell-output-markdown">
<span class="math display">\[\begin{array}{cc}

\begin{array}{|c|c|c|c|c|c|c|c|c|c|c|}
\hline
&amp; 1y &amp; 2y &amp; 3y &amp; 4y &amp; 5y &amp; 6y &amp; 7y &amp; 8y &amp; 9y &amp; 10y \\ \hline
1y &amp; 0.1733 &amp; 0.1465 &amp; 0.1380 &amp; 0.1321 &amp; 0.1270 &amp; 0.1225 &amp; 0.1182 &amp; 0.1143 &amp; 0.1107 &amp; 0.1073 \\ 2y &amp; 0.1597 &amp; 0.1427 &amp; 0.1356 &amp; 0.1301 &amp; 0.1252 &amp; 0.1207 &amp; 0.1165 &amp; 0.1127 &amp; 0.1091 &amp; 0.1057 \\ 3y &amp; 0.1510 &amp; 0.1376 &amp; 0.1312 &amp; 0.1260 &amp; 0.1212 &amp; 0.1169 &amp; 0.1128 &amp; 0.1091 &amp; 0.1055 &amp; 0.1023 \\ 4y &amp; 0.1441 &amp; 0.1326 &amp; 0.1265 &amp; 0.1215 &amp; 0.1169 &amp; 0.1127 &amp; 0.1088 &amp; 0.1052 &amp; 0.1018 &amp; 0.0987 \\ 5y &amp; 0.1382 &amp; 0.1278 &amp; 0.1221 &amp; 0.1173 &amp; 0.1129 &amp; 0.1088 &amp; 0.1050 &amp; 0.1015 &amp; 0.0982 &amp; 0.0952 \\ 7y &amp; 0.1279 &amp; 0.1191 &amp; 0.1139 &amp; 0.1094 &amp; 0.1053 &amp; 0.1015 &amp; 0.0979 &amp; 0.0947 &amp; 0.0916 &amp; 0.0888 \\ 10y &amp; 0.1155 &amp; 0.1079 &amp; 0.1032 &amp; 0.0992 &amp; 0.0954 &amp; 0.0920 &amp; 0.0888 &amp; 0.0858 &amp; 0.0830 &amp; 0.0805 \\ \hline
\end{array}

&amp; \quad

\begin{array}{|c|c|c|c|c|c|c|c|c|c|c|}
\hline
   &amp; 1y &amp; 2y &amp; 3y &amp; 4y &amp; 5y &amp; 6y &amp; 7y &amp; 8y &amp; 9y &amp; 10y \\ \hline
1y &amp; 0.1870 &amp; 0.1529 &amp; 0.1395 &amp; 0.1327 &amp; 0.1276 &amp; 0.1231 &amp; 0.1190 &amp; 0.1154 &amp; 0.1120 &amp; 0.1085 \\
2y &amp; 0.1603 &amp; 0.1427 &amp; 0.1348 &amp; 0.1295 &amp; 0.1251 &amp; 0.1210 &amp; 0.1174 &amp; 0.1139 &amp; 0.1103 &amp; 0.1068 \\
3y &amp; 0.1509 &amp; 0.1376 &amp; 0.1307 &amp; 0.1258 &amp; 0.1216 &amp; 0.1180 &amp; 0.1146 &amp; 0.1109 &amp; 0.1073 &amp; 0.1041 \\
4y &amp; 0.1422 &amp; 0.1311 &amp; 0.1252 &amp; 0.1210 &amp; 0.1175 &amp; 0.1142 &amp; 0.1106 &amp; 0.1069 &amp; 0.1037 &amp; 0.1005 \\
5y &amp; 0.1335 &amp; 0.1247 &amp; 0.1199 &amp; 0.1165 &amp; 0.1134 &amp; 0.1098 &amp; 0.1062 &amp; 0.1030 &amp; 0.0998 &amp; 0.0968 \\
6y &amp; 0.1218 &amp; 0.1161 &amp; 0.1124 &amp; 0.1087 &amp; 0.1050 &amp; 0.1018 &amp; 0.0986 &amp; 0.0954 &amp; 0.0928 &amp; 0.0902 \\
7y &amp; 0.1090 &amp; 0.1029 &amp; 0.0997 &amp; 0.0965 &amp; 0.0934 &amp; 0.0909 &amp; 0.0884 &amp; 0.0858 &amp; 0.0833 &amp; 0.0809 \\

\hline
\end{array}

\end{array}\]</span>
<p><span class="math display">\[\textbf{Table 4.3.} \text{ G2++ calibrated swaptions volatilities (My values on the left, Brigo-Mercurio values on the right)}\]</span></p>
</div>
</div>
<div id="cell-42" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="report_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="table-4.4.-swaptions-calibration-results-percentage-differences" class="level3">
<h3 class="anchored" data-anchor-id="table-4.4.-swaptions-calibration-results-percentage-differences">Table 4.4. Swaptions calibration results: percentage differences <a class="anchor" id="section_1_3_3" href=""></a></h3>
<div id="cell-44" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute percentage differences</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>relative_errors <span class="op">=</span> (fitted_vols <span class="op">-</span> market_vols) <span class="op">/</span> market_vols</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-45" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display cell-output-markdown">
<span class="math display">\[\begin{array}{cc}

\begin{array}{|c|c|c|c|c|c|c|c|c|c|c|}
\hline
&amp; 1y &amp; 2y &amp; 3y &amp; 4y &amp; 5y &amp; 6y &amp; 7y &amp; 8y &amp; 9y &amp; 10y \\ \hline
1y &amp; 5.69\% &amp; -5.50\% &amp; -3.52\% &amp; 0.81\% &amp; 2.44\% &amp; 2.91\% &amp; 1.93\% &amp; 2.09\% &amp; 0.65\% &amp; 0.31\% \\ 2y &amp; -0.21\% &amp; -4.88\% &amp; -2.41\% &amp; 0.86\% &amp; 2.64\% &amp; 1.44\% &amp; 0.47\% &amp; -0.28\% &amp; -0.84\% &amp; -2.12\% \\ 3y &amp; -3.82\% &amp; -5.08\% &amp; -2.09\% &amp; 1.58\% &amp; 1.86\% &amp; 1.61\% &amp; -0.17\% &amp; -0.86\% &amp; -2.27\% &amp; -3.49\% \\ 4y &amp; -2.63\% &amp; -2.52\% &amp; 0.43\% &amp; 2.11\% &amp; 2.58\% &amp; 0.65\% &amp; -0.16\% &amp; -1.71\% &amp; -3.05\% &amp; -4.21\% \\ 5y &amp; -1.29\% &amp; -0.13\% &amp; 0.92\% &amp; 2.88\% &amp; 2.61\% &amp; 1.69\% &amp; 0.02\% &amp; -1.46\% &amp; -3.69\% &amp; -4.79\% \\ 7y &amp; -1.61\% &amp; 0.10\% &amp; 0.80\% &amp; 4.19\% &amp; 4.23\% &amp; 2.48\% &amp; 0.96\% &amp; -1.39\% &amp; -3.57\% &amp; -4.54\% \\ 10y &amp; -0.46\% &amp; 0.85\% &amp; 3.25\% &amp; 6.65\% &amp; 6.05\% &amp; 3.36\% &amp; 2.05\% &amp; -0.24\% &amp; -2.32\% &amp; -4.22\% \\ \hline
\end{array}

&amp; \quad

\begin{array}{|c|c|c|c|c|c|c|c|c|c|c|}
\hline
   &amp; 1y &amp; 2y &amp; 3y &amp; 4y &amp; 5y &amp; 6y &amp; 7y &amp; 8y &amp; 9y &amp; 10y \\ \hline
1y &amp; 14.01\% &amp; -1.35\% &amp; -2.43\% &amp; 1.27\% &amp; 2.86\% &amp; 3.44\% &amp; 2.59\% &amp; 3.03\% &amp; 1.81\% &amp; 1.40\% \\
2y &amp; 0.17\% &amp; -4.88\% &amp; -3.03\% &amp; 0.39\% &amp; 2.51\% &amp; 1.67\% &amp; 1.19\% &amp; 0.84\% &amp; 0.31\% &amp; -1.12\% \\
3y &amp; -3.91\% &amp; -5.10\% &amp; -2.49\% &amp; 1.44\% &amp; 2.21\% &amp; 2.64\% &amp; 1.42\% &amp; 0.86\% &amp; -0.64\% &amp; -1.83\% \\
4y &amp; -3.92\% &amp; -3.59\% &amp; -0.61\% &amp; 1.65\% &amp; 3.08\% &amp; 1.97\% &amp; 1.44\% &amp; -0.07\% &amp; -1.26\% &amp; -2.41\% \\
5y &amp; -4.61\% &amp; -2.54\% &amp; -0.91\% &amp; 2.23\% &amp; 3.09\% &amp; 2.65\% &amp; 1.16\% &amp; -0.01\% &amp; -2.13\% &amp; -3.25\% \\
6y &amp; -6.29\% &amp; -2.47\% &amp; -0.50\% &amp; 3.51\% &amp; 3.94\% &amp; 2.82\% &amp; 1.65\% &amp; -0.58\% &amp; -2.33\% &amp; -3.01\% \\
7y &amp; -6.08\% &amp; -3.81\% &amp; -0.34\% &amp; 3.80\% &amp; 3.79\% &amp; 2.17\% &amp; 1.58\% &amp; -0.21\% &amp; -2.00\% &amp; -3.69\% \\

\hline
\end{array}

\end{array}\]</span>
<p><span class="math display">\[\textbf{Table 4.4.} \text{ Swaptions calibration results: percentage differences (My values on the left, Brigo-Mercurio values on the right).}\]</span></p>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="20">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="report_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="exercise-2-assessment-of-calibration-uncertainty" class="level1">
<h1>EXERCISE 2/ Assessment of calibration uncertainty <a class="anchor" id="chapter2" href=""></a></h1>
<hr>
<section id="the-black-karasinski-model" class="level2">
<h2 class="anchored" data-anchor-id="the-black-karasinski-model">The Black-Karasinski model <a class="anchor" id="section_2_0" href=""></a></h2>
<p>This section provides a synthesis of the documents I have reviewed during my research, as referenced in the bibliography. In particular, I would like to highlight two key papers:</p>
<ul>
<li>The foundational article by <span class="citation" data-cites="black1991bond">(<a href="#ref-black1991bond" role="doc-biblioref">Black and Karasinski 1991</a>)</span></li>
<li>A more recent work by <span class="citation" data-cites="karasinski2021black">(<a href="#ref-karasinski2021black" role="doc-biblioref">Karasinski and Turfus 2021</a>)</span>, which recounts the story of how the model was developed and examines its subsequent impact.</li>
</ul>
<section id="the-need-of-a-new-model" class="level3">
<h3 class="anchored" data-anchor-id="the-need-of-a-new-model">The need of a new model <a class="anchor" id="section_2_0_00" href=""></a></h3>
<p>Ideally one wants a process for the short-term interest rate such that negative interest rates are prevented, but the zero level may be reached and maintained for extended periods of time. None of the normal, lognormal and square root processes, satisfy both these requirements.</p>
<ul>
<li>A normal process (e.g.&nbsp;Hull-White model) does not prevent interest rate to become negative. Moreover volatility does not increase as the short rate rose higher than the forward rate.</li>
<li>A lognormal process (e.g.&nbsp;Dothan model) does not admit a zero interest rate.</li>
<li>A square root process (e.g.&nbsp;Cox-Ingersoll-Ros model) process makes the zero level a reflecting barrier. It doesn’t allow rates to get stuck at zero.</li>
</ul>
<p>The Black-Karasinski model proved highly attractive at the time as it addressed these deficiencies.</p>
</section>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions <a class="anchor" id="section_2_0_1" href=""></a></h3>
<p>The standard assumptions underlying perfect markets are made :</p>
<ul>
<li>changes in the yields of all zero coupon bonds are perfectly correlated,</li>
<li>the expected one period returns are the same for all securities,</li>
<li>the market is free of taxes and transaction costs.</li>
</ul>
</section>
<section id="log-normality" class="level3">
<h3 class="anchored" data-anchor-id="log-normality">Log normality <a class="anchor" id="section_2_0_2" href=""></a></h3>
<p>Since the market formulas for caps and swaptions are based on the assumption of lognormal rates, it seemed reasonable to choose the same distribution for the instantaneous short-rate process. Notice, however, that a lognormal instantaneous short-rate process does not lead to log;normal simple forward rates or lognormal swap rates.</p>
<p>A lognormal model is a model where short-term interest rate are lognormally distributed. The short-term interest rate is assumed to have a lognormal distribution at any time horizon. A lognormal distribution is fully described by its mean and variance, which are functions of time, so we have a different lognormal distribution of the short-term interest rate at each future time. The lognormality feature holds several advantages for calibration of the model. Negative interest rates are prevented and the volatility input may be specified in percentage terms, i.e.&nbsp;the volatility refers to relative price moves. This is the market convention for quoting volatilities, so calibration to market-observed volatilities is simplified.</p>
<ul>
<li><p>Dothan (1978) introduced a lognormal model for interest rates in which the logarithm of the spot rate follows a Brownian motion with constant drift.</p></li>
<li><p>Another way of obtaining a lognormal model for interest rates is to suppose that the logarithm of the spot rate follows an Ornstein-Uhlenbeck process. In other words the instantaneous short rate process evolves as the exponential of an Ornstein-Uhlenbeck process. <span class="math display">\[\mathrm{d}\big(\ln(r(t))\big)
= \Big( \theta - \phi\ln\big(r(t)\big)\Big)\mathrm{d}t + \sigma\,\mathrm{d}W_t\]</span> – <span class="math inline">\(\phi\)</span> gives a measure of the speed at which <span class="math inline">\(\ln\big(r(t)\big)\)</span> tends to its long-term value</p>
<p>– <span class="math inline">\(\sigma\)</span> is the standard deviation rate of <span class="math inline">\(\frac{\mathrm{d}r(t)}{r(t)}\)</span>, namely the standard deviation per time unit of the instantaneous return of <span class="math inline">\(r(t)\)</span>. <!-- BK do not attempt to specify a process which accurately depicts the evolution of the short-term interest rate, but rather a short-term interest rate process which can be fitted to observed market prices and hence used to price securities in a consistent manner. The future risk-neutral distribution of the short-term interest rate generated by the model is not the true distribution, but rather a distribution which leads to correct option prices. --></p></li>
</ul>
</section>
<section id="mean-reversion" class="level3">
<h3 class="anchored" data-anchor-id="mean-reversion">Mean reversion <a class="anchor" id="section_2_0_3" href=""></a></h3>
<p>When mean reversion is combined with a lognormal model, we have three time-dependent factors, an example being the BDT model, <span class="math display">\[\mathrm{d}\big(\ln(r(t))\big)
= \Big( \theta(t) - \phi(t)\ln\big(r(t)\big)\Big)\mathrm{d}t + \sigma(t)\,\mathrm{d}W_t\]</span> However, here <span class="math inline">\(\phi(t)\)</span> is a function of <span class="math inline">\(\sigma(t)\)</span>. Dropping this functional dependence, the Black-Karasinski model may be written as: <span class="math display">\[\mathrm{d}\big(\ln(r(t))\big)
= \phi(t)\big( \ln(\mu(t)) - \ln(r(t))\big)\mathrm{d}t + \sigma(t)\,\mathrm{d}W_t\]</span></p>
<ul>
<li><span class="math inline">\(\mu(t)\)</span> be the target interest rate, i.e.&nbsp;the reversion level</li>
<li><span class="math inline">\(\phi(t)\)</span> is the speed or rate of the mean reversion <!-- - $\sigma(t)$ the local volatility, i.e. the volatility of the short-term interest rate.  --></li>
</ul>
<p>The Black-Karasinski model is a model, where the target rate, mean reversion rate and local volatility are deterministic functions of time. The specification of three time-dependent factors allows the future short-term interest rate volatilities to be specified independently of the initial volatility term structure. <!-- 
By letting θ be the only time dependent function, we decide to
 exactly fit the current term structure of rates and to keep the other two
 parameters at our disposal for the calibration to option data. --></p>
</section>
<section id="drawbacks" class="level3">
<h3 class="anchored" data-anchor-id="drawbacks">Drawbacks <a class="anchor" id="section_2_0_4" href=""></a></h3>
<ul>
<li><p>The Black-Karasinski model is not an affine term-structure model.</p></li>
<li><p>The Black-Karasinski model is less analytically tractable than the Hull-White model since it does not yield explicit expressions for either zero-coupon bonds or options on them.</p></li>
<li><p>The Black-Karasinski model shares the explosion problem, common to all lognormal models for the spot rate of interest, that the expected value of the money-market account is infinite no matter which maturity is considered <span class="math inline">\(\mathbb{E}[B_t]=\infty\)</span>. This means that in an arbitrarily small time we can make infinite money on average starting from one unit of currency. As a consequence, the price of a Eurodollar future is infinite, too.</p></li>
</ul>
</section>
</section>
<section id="a-few-theoretical-results-before-to-start-exercise-2" class="level2">
<h2 class="anchored" data-anchor-id="a-few-theoretical-results-before-to-start-exercise-2">A few theoretical results before to start exercise 2<a class="anchor" id="section_2_0_5" href=""></a></h2>
<p>We assume the following dynamics <span class="math display">\[\mathrm{d}\big(\ln(S_{i,t})\big)
= \kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} - \ln(S_{i,t})\right)\mathrm{d}t + \sigma\,\mathrm{d}W_t\]</span></p>
<div id="cell-62" class="cell" data-execution_count="21">
<div class="cell-output cell-output-display">

<div style="border: 2px solid #ccc; padding: 10px; border-radius: 5px; 
            background-color: #f0f0f0; margin-bottom: 20px;">
    $$ 
    \frac{\mathrm{d}S_{i,t}}{S_{i,t}}
    = \left(\kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} - \ln(S_{i,t})\right) + \frac{\sigma^2}{2}\right)\mathrm{d}t + \sigma \,\mathrm{d}W_t
    $$
</div>
</div>
</div>
<details style="margin: 0px 0 20px 0;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;  /* Gris foncé des titres Quarto */
    border: none;
    border-radius: 4px;  /* Arrondi identique aux cellules de code */
    transition: all 0.2s ease;
">Proof</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    border-radius: 0 4px 4px 4px;  /* Arrondis coordonnés avec le bouton */
" markdown="1">
First the dynamics gives \( \mathrm{d}\langle \ln(S_{i,t})\rangle = \sigma^2\,\mathrm{d}t \).
Let 
$$\begin{array}[t]{@{}lrcl}
f : &amp;  \mathbb{R} &amp; \longrightarrow &amp; \mathbb{R}_+^* \\
&amp; x &amp; \longmapsto &amp;  \mathrm{e}^x \end{array}$$
so that 
$$%\forall t\in\mathbb{R}_+\quad 
S_{i,t}
= \mathrm{e}^{\ln(S_{i,t})}
= f\big(\ln(S_{i,t})\big)$$
One has \( f\in\mathcal{C}^2(\mathbb{R},\mathbb{R}_+^*) \) and \( f''=f'=f \).
By Itô's lemma (using that \( {\big(\ln(S_{i,t})\big)}_{t\in \mathbb{R}_+} \) is a semimartingale)
\begin{align*}
    \mathrm{d}S_{i,t}
    &amp;= \mathrm{d}f\big(\ln(S_{i,t})\big) \\
    &amp;= f'\big(\ln(S_{i,t})\big)\,\mathrm{d}\big(\ln(S_{i,t})\big) + \frac{1}{2}f''\big(\ln(S_{i,t})\big)\,\mathrm{d}\langle \ln(S_{i,t})\rangle \\
    &amp;= f\big(\ln(S_{i,t})\big)\left(\kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} - \ln(S_{i,t})\right)\mathrm{d}t + \sigma\,\mathrm{d}W_t\right) + \frac{1}{2}f\big(\ln(S_{i,t})\big)\sigma^2\,\mathrm{d}t \\
    &amp;= S_{i,t}\left(\kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} - \ln(S_{i,t})\right) + \frac{\sigma^2}{2}\right)\mathrm{d}t + \sigma S_{i,t}\,\mathrm{d}W_t \\
\end{align*}

</div>
</details>
<p>One might wonder where the term <span class="math inline">\(\frac{\sigma^2}{4\kappa}\)</span> comes from. The following proof provides an answer.</p>
<div id="cell-65" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display">

<div style="border: 2px solid #ccc; padding: 10px; border-radius: 5px; 
            background-color: #f0f0f0; margin-bottom: 20px;">
    $$ 
    \lim\limits_{t\rightarrow +\infty}\mathbb{E}[S_{i,t}\,|\,\mathcal{F}_{t_0}] = \theta
    $$
</div>
</div>
</div>
<details style="margin: 0px 0 20px 0;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;  /* Gris foncé des titres Quarto */
    border: none;
    border-radius: 4px;  /* Arrondi identique aux cellules de code */
    transition: all 0.2s ease;
">Proof</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    border-radius: 0 4px 4px 4px;  /* Arrondis coordonnés avec le bouton */
" markdown="1">
\begin{align*}
    \lim\limits_{t\rightarrow +\infty}\mathbb{E}[S_{i,t}\,|\,\mathcal{F}_{t_0}]
    &amp;= \lim\limits_{t\rightarrow +\infty} \mathbb{E}\left[\mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa}) (1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma \int_{t_0}^t \mathrm{e}^{-\kappa (t-s)} \mathrm{d}W_s}\,\Big|\,\mathcal{F}_{t_0}\right] \\
    &amp;= \lim\limits_{t\rightarrow +\infty} \mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa}) (1-\mathrm{e}^{-\kappa (t-t_0)})}
    \mathbb{E}\left[\mathrm{e}^{ \sigma \int_{t_0}^t \mathrm{e}^{-\kappa (t-s)} \mathrm{d}W_s}\right] \\
    &amp;= \lim\limits_{t\rightarrow +\infty} \mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa}) (1-\mathrm{e}^{-\kappa (t-t_0)})}
    \mathrm{e}^{ \frac{1}{2}\mathrm{Var}(\sigma \int_{t_0}^t \mathrm{e}^{-\kappa (t-s)} \mathrm{d}W_s)} \\
    &amp;= \lim\limits_{t\rightarrow +\infty} \mathrm{e}^{ \mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa})(1-\mathrm{e}^{-\kappa (t-t_0)}) +\frac{\sigma^2}{4\kappa} (1-\mathrm{e}^{-2\kappa (t-t_0)})}\\
    &amp;=  \mathrm{e}^{ \lim\limits_{t\rightarrow +\infty} \mathrm{e}^{ -\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa})(1-\mathrm{e}^{-\kappa (t-t_0)}) +\frac{\sigma^2}{4\kappa} (1-\mathrm{e}^{-2\kappa (t-t_0)})}\\
    &amp;= \mathrm{e}^{\ln(\theta)-\frac{\sigma^2}{4\kappa } + \frac{\sigma^2}{4\kappa}} \\
    &amp;= \mathrm{e}^{\ln(\theta)} \\
    &amp;= \theta
\end{align*}
<b>Remark.</b> For \( S_{i,t_0}:=\theta \), 
\begin{align*}\mathbb{E}[S_{i,t}\,|\,\mathcal{F}_{t_0}]
&amp;= \mathrm{e}^{ \mathrm{e}^{-\kappa (t-t_0)}\ln(\theta) + (\ln(\theta) - \frac{\sigma^2}{4\kappa})(1-\mathrm{e}^{-\kappa (t-t_0)}) + \frac{\sigma^2}{4\kappa} (1-\mathrm{e}^{-2\kappa (t-t_0)})} \\
&amp;= \mathrm{e}^{\ln(\theta) - \frac{\sigma^2}{4\kappa}(1-\mathrm{e}^{-\kappa (t-t_0)}) + \frac{\sigma^2}{4\kappa} (1-\mathrm{e}^{-2\kappa (t-t_0)})} \\
&amp;= \theta\mathrm{e}^{\frac{\sigma^2}{4\kappa} \mathrm{e}^{-\kappa (t-t_0)}(1-\mathrm{e}^{-\kappa (t-t_0)})}
\end{align*}
</div>
</details>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section">1. <a class="anchor" id="section_2_1" href=""></a></h2>
<p>Let’s show that <span class="math display">\[S_{i,t}
= \mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa}) (1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma \int_{t_0}^t \mathrm{e}^{-\kappa (t-s)} \mathrm{d}W_s}\]</span></p>
<details style="margin: 0px 0 20px 0;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;  /* Gris foncé des titres Quarto */
    border: none;
    border-radius: 4px;  /* Arrondi identique aux cellules de code */
    transition: all 0.2s ease;
">Proof 1</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    border-radius: 0 4px 4px 4px;  /* Arrondis coordonnés avec le bouton */
" markdown="1">

By <a href="https://planetmath.org/stochasticintegrationbyparts">stochastic integration by parts</a> 
    (using that 
    \( (\mathrm{e}^{\kappa t})_{t\in\mathbb{R}_+} \) and 
    \( (\ln(S_{i,t}))_{t\in\mathbb{R}_+} \) 
    are semimartingales)
\begin{eqnarray*}
    %\forall t\in\mathbb{R}_+\quad 
    \mathrm{d}\big(\mathrm{e}^{\kappa t}\ln(S_{i,t})\big)
    &amp;=&amp; \mathrm{e}^{\kappa t}\,\mathrm{d}\big(\ln(S_{i,t})\big) + \ln(S_{i,t})\,\mathrm{d}(\mathrm{e}^{\kappa t}) \textcolor{gray}{\ +\ \mathrm{d}\langle\mathrm{e}^{\theta \cdot},\ln(S_{i,\cdot })\rangle_t} \\
    &amp;=&amp; \mathrm{e}^{\kappa t}\left(\kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} - \ln(S_{i,t})\right)\mathrm{d}t + \sigma\,\mathrm{d}W_t\right) + \kappa \mathrm{e}^{\kappa t} \ln(S_{i,t})\,\mathrm{d}t \textcolor{gray}{\ +\ 0} \\
    &amp;=&amp; \kappa\left(\ln(\theta)-\frac{\sigma^2}{4\kappa}\right) \mathrm{e}^{\kappa t}\,\mathrm{d}t + \sigma\mathrm{e}^{\kappa t}\,\mathrm{d}W_t
\end{eqnarray*}
By integration
\begin{eqnarray*}
    %\forall t\in\mathbb{R}_+\quad 
    \mathrm{e}^{\kappa t}\ln(S_{i,t})
    &amp;=&amp; \mathrm{e}^{\kappa t_0}\ln(S_{i,t_0}) + \left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right) \int_{t_0}^t \kappa\mathrm{e}^{\kappa s}\,\mathrm{d}s + \sigma\int_0^t\mathrm{e}^{\kappa s}\mathrm{d}W_s \\
    &amp;=&amp; \mathrm{e}^{\kappa t_0}\ln(S_{i,t_0})+\left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right) \left[\mathrm{e}^{\kappa s}\right]_{t_0}^t + \sigma\int_0^t\mathrm{e}^{\kappa s}\mathrm{d}W_s \\
    &amp;=&amp; \mathrm{e}^{\kappa t_0}\ln(S_{i,t_0})+\left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right) \left(\mathrm{e}^{\kappa t}-\mathrm{e}^{\kappa t_0}\right) + \sigma\int_0^t\mathrm{e}^{\kappa s}\mathrm{d}W_s \\
\end{eqnarray*}
so 
$$%\forall t\in\mathbb{R}_+\quad 
\ln(S_{i,t})
= \mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0})+\left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right)(1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma \int_{t_0}^t\mathrm{e}^{-\kappa (t-s)}\mathrm{d}W_s$$
Eventually
$$%\forall t\in\mathbb{R}_+\quad 
S_{i,t}
= \mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0})+\left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right)(1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma \int_{t_0}^t\mathrm{e}^{-\kappa (t-s)}\mathrm{d}W_s}$$


</div>
</details>
<details style="margin: 0px 0 24px;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;  /* Gris foncé des titres Quarto */
    border: none;
    border-radius: 4px;  /* Arrondi identique aux cellules de code */
    transition: all 0.2s ease;
">Proof 2</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    margin-bottom: 12px;
    border-radius: 0 4px 4px 4px;  /* Arrondis coordonnés avec le bouton */
" markdown="1">

Let 
$$\begin{array}[t]{@{}lrcl} 
f : &amp; \mathbb{R}_+\times\mathbb{R} &amp; \longrightarrow &amp; \mathbb{R} \\
&amp; (t,x) &amp; \longmapsto &amp; \mathrm{e}^{\kappa t}x \end{array}$$
One has \( f\in\mathcal{C}^2(\mathbb{R}_+\times\mathbb{R},\mathbb{R}) \) and 
$$\forall (t,x)\in \mathbb{R}_+\times\mathbb{R}\quad 
\begin{cases}
\frac{\partial f}{\partial t}(t,x)=\kappa f(t,x) \\
% \frac{\partial^2 f}{\partial t^2}(t,x)=\kappa^2 f(t,x) \\
\frac{\partial f}{\partial x}(t,x)=\mathrm{e}^{\kappa t} \\
% \frac{\partial^2 f}{\partial x^2}(t,x) = 0 \\
% \frac{\partial^2 f}{\partial t\partial x}(t,x) = \kappa \mathrm{e}^{\kappa t}
\end{cases}$$
By Itô's lemma (using that \( {(t)}_{t\in\mathbb{R}_+} \) and  \({\big(\ln(S_{i,t})\big)}_{t\in\mathbb{R}_+} \) are semimartingales)
\begin{eqnarray*}
    %\forall t\in\mathbb{R}_+\quad 
    \mathrm{e}^{\kappa t}\ln(S_{i,t})
    &amp;=&amp; f\big(t,\ln(S_{i,t})\big) \\
    &amp;=&amp; f\big(t_0,\ln(S_{i,t_0})\big) + \int_{t_0}^t \frac{\partial f}{\partial t}\big(s,\ln(S_{i,s})\big)\,\mathrm{d}s + \int_{t_0}^t \frac{\partial f}{\partial x}\big(s,\ln(S_{i,s})\big)\,\mathrm{d}\big(\ln(S_{i,s})\big) \\ 
    &amp;=&amp; \mathrm{e}^{\kappa t_0}\ln(S_{i,t_0}) + \int_{t_0}^t \kappa \mathrm{e}^{\kappa s}\ln(S_{i,s})\,\mathrm{d}s + \int_{t_0}^t \mathrm{e}^{\kappa s}\left(\kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} - \ln(S_{i,s})\right)\mathrm{d}s + \sigma\,\mathrm{d}W_s\right) \\ 
    &amp;=&amp; \mathrm{e}^{\kappa  t_0}\ln(S_{i,t_0}) + \int_{t_0}^t \mathrm{e}^{\kappa s}\left(\kappa \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} \right)\mathrm{d}s + \sigma\,\mathrm{d}W_s\right) \\ 
    &amp;=&amp; \mathrm{e}^{\kappa  t_0}\ln(S_{i,t_0}) + \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} \right) \int_{t_0}^t \kappa\mathrm{e}^{\kappa s}\mathrm{d}s + \int_{t_0}^t \mathrm{e}^{\kappa s}\sigma\,\mathrm{d}W_s  \\ 
    &amp;=&amp; \mathrm{e}^{\kappa  t_0}\ln(S_{i,t_0}) + \left(\ln(\theta) - \frac{\sigma^2}{4\kappa} \right) [\mathrm{e}^{\kappa s}]_{t_0}^t + \int_{t_0}^t \mathrm{e}^{\kappa s}\sigma\,\mathrm{d}W_s  \\ 
    &amp;=&amp; \mathrm{e}^{\kappa  t_0}\ln(S_{i,t_0}) + \big(\ln(\theta) - \frac{\sigma^2}{4\kappa} \big) (\mathrm{e}^{\kappa t} - \mathrm{e}^{\kappa t_0}) + \int_{t_0}^t \mathrm{e}^{\kappa s}\sigma\,\mathrm{d}W_s  \\ 
\end{eqnarray*}
so
$$%\forall t\in\mathbb{R}_+\quad 
\ln(S_{i,t})
= \mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + \left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right)(1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma \int_{t_0}^t\mathrm{e}^{-\kappa (t-s)}\mathrm{d}W_s$$
Eventually 
$$%\forall t\in\mathbb{R}_+\quad 
S_{i,t}
= \mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0})+\left(\ln(\theta) - \frac{\sigma^2}{4\kappa}\right)(1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma \int_{t_0}^t\mathrm{e}^{-\kappa (t-s)}\mathrm{d}W_s}$$

</div>
</details>
<p>The integral <span class="math inline">\(\sigma \int_{t_0}^t \mathrm{e}^{-\kappa (t-s)}\,\mathrm{d}W_s\)</span> is a Wiener integral so <span class="math display">\[\begin{align*}
    \sigma \int_{t_0}^t \mathrm{e}^{-\kappa (t-s)}\,\mathrm{d}W_s
    &amp;\sim  \mathcal{N}\left(0, \sigma^2\int_{t_0}^t  \mathrm{e}^{-2\kappa (t-s)}\,\mathrm{d}s \right) \\
    &amp;= \mathcal{N}\left(0, \sigma^2 \frac{1}{2\kappa} \left[ \mathrm{e}^{-2\kappa (t-s)}\right]_{t_0}^t \right) \\
    &amp;= \mathcal{N}\left(0, \frac{\sigma^2}{2\kappa} (1-\mathrm{e}^{-2\kappa (t-t_0)})\right) \\
    &amp;\sim  \sigma\sqrt{\frac{1-\mathrm{e}^{-2\kappa (t-t_0)}}{2\kappa}} Z
\end{align*}\]</span> where <span class="math inline">\(Z\sim \mathcal{N}(0,1)\)</span>. So <span class="math display">\[S_{i,t}
\sim \mathrm{e}^{\mathrm{e}^{-\kappa (t-t_0)}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa}) (1-\mathrm{e}^{-\kappa (t-t_0)}) + \sigma\sqrt{\frac{1-\mathrm{e}^{-2\kappa (t-t_0)}}{2\kappa}} Z }\]</span> For a given time step <span class="math inline">\(\Delta t:= t-t_0\)</span>, <span class="math display">\[S_{i,t}
\sim \mathrm{e}^{\mathrm{e}^{-\kappa \Delta t}\ln(S_{i,t_0}) + (\ln(\theta) - \frac{\sigma^2}{4\kappa}) (1-\mathrm{e}^{-\kappa \Delta t}) + \sigma\sqrt{\frac{1-\mathrm{e}^{-2\kappa \Delta t}}{2\kappa}} Z }\]</span></p>
<details style="margin: 0px 0 20px 0;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;  /* Gris foncé des titres Quarto */
    border: none;
    border-radius: 4px;  /* Arrondi identique aux cellules de code */
    transition: all 0.2s ease;
">Remark</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    border-radius: 0 4px 4px 4px;  /* Arrondis coordonnés avec le bouton */
" markdown="1">
For \( S_{i,t_0}:=\theta \), 
$$S_{i,t} = \mathrm{e}^{\ln(\theta) -\frac{\sigma^2}{4\kappa}(1-\mathrm{e}^{-\kappa (t-t_0)})+\sigma\int_{t_0}^t \mathrm{e}^{-\kappa (t-s)}\,\mathrm{d}W_s}$$ 
so 
$$S_{i,t} \sim \mathcal{LN}\left(\ln(\theta) -\frac{\sigma^2}{4\kappa}(1-\mathrm{e}^{-\kappa (t-t_0)}), \sigma^2 \frac{1-\mathrm{e}^{-2\kappa (t-t_0)}}{2\kappa}\right)$$ 


</div>
</details>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1">2. <a class="anchor" id="section_2_2" href=""></a></h2>
<div id="cell-74" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_black_karasinski(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    num_issuers: <span class="bu">int</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    num_time_steps: <span class="bu">int</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    delta_t: <span class="bu">float</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    kappa: <span class="bu">float</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    theta: <span class="bu">float</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    sigma: <span class="bu">float</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    initial_spreads: np.ndarray</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulates credit spread paths for multiple issuers using the Black-Karasinski model.</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - num_issuers: Number of underlying issuers (N).</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    - num_time_steps: Number of time steps to simulate (T).</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">    - delta_t: Time step size (Δt).</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    - kappa: Mean-reversion speed (κ).</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">    - theta: Long-term mean spread (θ).</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">    - sigma: Volatility parameter (σ).</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">    - initial_spreads: Array of initial spreads for each issuer (shape: (N,)).</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">    - Simulated spread paths (shape: (N, T+1)), including initial values.</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Precompute constants for the discretized formula</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> np.exp(<span class="op">-</span>kappa <span class="op">*</span> delta_t)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    mu_adj <span class="op">=</span> np.log(theta) <span class="op">-</span> (sigma <span class="op">**</span> <span class="dv">2</span>) <span class="op">/</span> (<span class="dv">4</span> <span class="op">*</span> kappa)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> mu_adj <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> a)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    variance_factor <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span><span class="dv">2</span> <span class="op">*</span> kappa <span class="op">*</span> delta_t)) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> kappa)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> sigma <span class="op">*</span> np.sqrt(variance_factor)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize paths matrix (N issuers x T+1 time steps)</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    paths <span class="op">=</span> np.zeros((num_issuers, num_time_steps <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    paths[:, <span class="dv">0</span>] <span class="op">=</span> initial_spreads</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate over time steps to simulate paths</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, num_time_steps <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate independent Z for each issuer</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="dv">1</span>, num_issuers)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update log-spreads using vectorized operations</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        log_prev <span class="op">=</span> np.log(paths[:, t <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        log_next <span class="op">=</span> a <span class="op">*</span> log_prev <span class="op">+</span> b <span class="op">+</span> c <span class="op">*</span> Z</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        paths[:, t] <span class="op">=</span> np.exp(log_next)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> paths</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-75" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N"</span>: <span class="dv">3</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"T"</span>: <span class="dv">1000</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dt"</span>: <span class="fl">0.1</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kappa"</span>: <span class="fl">0.1</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theta"</span>: <span class="fl">0.05</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma"</span>: <span class="fl">0.2</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>initial_spreads <span class="op">=</span> np.full(params[<span class="st">"N"</span>], params[<span class="st">"theta"</span>])</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>paths <span class="op">=</span> simulate_black_karasinski(</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    params[<span class="st">"N"</span>], params[<span class="st">"T"</span>], params[<span class="st">"dt"</span>], </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    params[<span class="st">"kappa"</span>], params[<span class="st">"theta"</span>], params[<span class="st">"sigma"</span>], </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    initial_spreads</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell" data-execution_count="25">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="report_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<details style="margin: 0px 0 20px 0;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;
    border: none;
    border-radius: 4px;
    transition: all 0.2s ease;
">
Remark
</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    border-radius: 0 4px 4px 4px;
">
<p>Let’s plot a graph to visualize the formula <span class="math inline">\(\lim\limits_{t\rightarrow +\infty}\mathbb{E}[S_{i,t}] = \theta\)</span>. At each time <span class="math inline">\(t\)</span>, we will :</p>
<ul>
<li>Represent the theoretical moment <span class="math inline">\(\theta e^{\frac{\sigma^2}{4\kappa}e^{-\kappa t}(1-e^{-\kappa t})}\)</span>.</li>
<li>Represent the empirical moment <span class="math inline">\(\frac{1}{N}\sum_{i=1}^N S_{i,t}\)</span> for <span class="math inline">\(N=100000\)</span>.</li>
</ul>
<p><img src="report_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
</details>
</section>
<section id="section-2" class="level2">
<h2 class="anchored" data-anchor-id="section-2">3. <a class="anchor" id="section_2_3" href=""></a></h2>
<p>Let <span class="math inline">\(T\)</span> be the number of time steps and <span class="math inline">\(N\)</span> the number of underlying issuers. We assume that <span class="math display">\[{\left(\ln\left(\frac{S_{i,{t+\Delta t}}}{S_{i,t}}\right)\right)}_{(i,t)\in\{1,\dots,N\}\times \{0,\dots,T-1\}}
\overset{\text{i.i.d.}}{\sim}\mathcal{N}(0, \sigma^2 \Delta t)\]</span> so by the strong law of large numbers <span class="math display">\[\sqrt{\frac{1}{N\times T}\sum_{i=1}^N \sum_{t=0}^{T-1} \ln^2\left(\frac{S_{i,t+\Delta t}}{S_{i,t}}\right)}
\xrightarrow[N\times T\rightarrow+\infty]{a.s.} \sqrt{\mathbb{E}\left[\ln^2\left(\frac{S_{i,t+\Delta t}}{S_{i,t}}\right)\right]}
= \sqrt{\sigma^2 \Delta t}
= \sigma \sqrt{\Delta t}\]</span> So <span class="math display">\[\sigma \approx \frac{1}{\Delta t}\sqrt{\frac{1}{N\times T}\sum_{i=1}^N \sum_{t=0}^{T-1} \ln^2\left(\frac{S_{i,t+\Delta t}}{S_{i,t}}\right)}\]</span></p>
<div id="cell-81" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_volatility(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    paths: np.ndarray,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    delta_t: <span class="bu">float</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimates the volatility parameter σ from simulated spread paths, assuming log-returns</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    follow a Brownian motion (ignoring mean reversion effects).</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - paths: Simulated spread paths (shape: (N, T+1)), as returned by `simulate_black_karasinski`.</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - delta_t: Time step size (Δt) used in the simulation.</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - Estimated volatility (σ) under the Brownian motion assumption.</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute log-returns: ln(S_t / S_{t-1}) for all issuers and time steps</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    log_returns <span class="op">=</span> np.log(paths[:, <span class="dv">1</span>:] <span class="op">/</span> paths[:, :<span class="op">-</span><span class="dv">1</span>])  <span class="co"># Shape: (N, T)</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate root-mean-square (RMS) of log-returns (σ_estimate * sqrt(Δt) = RMS)</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    rms_log_returns <span class="op">=</span> np.sqrt(np.mean(log_returns <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust for time step to estimate σ</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    sigma_estimate <span class="op">=</span> rms_log_returns <span class="op">/</span> np.sqrt(delta_t)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigma_estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="section-3" class="level2">
<h2 class="anchored" data-anchor-id="section-3">4. <a class="anchor" id="section_2_4" href=""></a></h2>
<div id="cell-83" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> monte_carlo_volatility(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    num_simulations: <span class="bu">int</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    num_issuers: <span class="bu">int</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    num_time_steps: <span class="bu">int</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    delta_t: <span class="bu">float</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    kappa: <span class="bu">float</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    theta: <span class="bu">float</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    sigma: <span class="bu">float</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    initial_spreads: Optional[np.ndarray] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    seed: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Runs Monte Carlo simulations to estimate volatility (σ) under the Brownian motion assumption.</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">    - num_simulations: Number of Monte Carlo runs (M).</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">    - num_issuers: Number of underlying issuers (N).</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">    - num_time_steps: Number of time steps (T).</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co">    - delta_t: Time step size (Δt).</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co">    - kappa, theta, sigma: Black-Karasinski model parameters.</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">    - initial_spreads: Initial spreads for issuers (if None, all start at θ).</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co">    - seed: Random seed for reproducibility.</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co">    - Vector of estimated σ values (shape: (M,)).</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> initial_spreads <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        initial_spreads <span class="op">=</span> np.full(num_issuers, theta)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    estimated_sigmas <span class="op">=</span> np.zeros(num_simulations)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_simulations):</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        paths <span class="op">=</span> simulate_black_karasinski(</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>            num_issuers<span class="op">=</span>num_issuers,</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>            num_time_steps<span class="op">=</span>num_time_steps,</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>            delta_t<span class="op">=</span>delta_t,</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            kappa<span class="op">=</span>kappa,</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>            theta<span class="op">=</span>theta,</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>            sigma<span class="op">=</span>sigma,</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>            initial_spreads<span class="op">=</span>initial_spreads</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        estimated_sigmas[i] <span class="op">=</span> estimate_volatility(paths, delta_t)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> estimated_sigmas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s try 3 sets of configurations.</p>
<div id="cell-85" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>config1 <span class="op">=</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_simulations"</span>: <span class="dv">1000</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_issuers"</span>: <span class="dv">1000</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_time_steps"</span>: <span class="dv">1000</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"delta_t"</span>: <span class="fl">0.1</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kappa"</span>: <span class="fl">0.1</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theta"</span>: <span class="fl">0.05</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma"</span>: <span class="fl">0.2</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed"</span>: <span class="dv">42</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>config2 <span class="op">=</span> {</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_simulations"</span>: <span class="dv">500</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_issuers"</span>: <span class="dv">500</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_time_steps"</span>: <span class="dv">1000</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"delta_t"</span>: <span class="fl">0.1</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kappa"</span>: <span class="fl">0.3</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theta"</span>: <span class="fl">0.05</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma"</span>: <span class="fl">0.2</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed"</span>: <span class="dv">42</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>config3 <span class="op">=</span> {</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_simulations"</span>: <span class="dv">500</span>,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_issuers"</span>: <span class="dv">1000</span>,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_time_steps"</span>: <span class="dv">500</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"delta_t"</span>: <span class="fl">1.0</span>,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kappa"</span>: <span class="fl">0.1</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theta"</span>: <span class="fl">0.05</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma"</span>: <span class="fl">0.5</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed"</span>: <span class="dv">42</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Appel de la fonction en décompressant le dictionnaire</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>config1_result <span class="op">=</span> monte_carlo_volatility(<span class="op">**</span>config1)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>config2_result <span class="op">=</span> monte_carlo_volatility(<span class="op">**</span>config2)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>config3_result <span class="op">=</span> monte_carlo_volatility(<span class="op">**</span>config3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The last column of the following table contains the results.</p>
<div id="cell-87" class="cell" data-execution_count="31">
<div class="cell-output cell-output-display cell-output-markdown">
<span class="math display">\[\begin{array}{|c|c|c|c|c|c|c|c|}
\hline
\texttt{num\_simulations} &amp; \texttt{num\_issuers} &amp; \texttt{num\_time\_steps} &amp; \texttt{delta\_t} &amp; \texttt{kappa} &amp; \texttt{theta} &amp; \texttt{sigma} &amp; \textbf{re-estimated\ } \sigma \\ \hline
1000 &amp; 1000 &amp; 1000 &amp; 0.1 &amp; 0.1 &amp; 0.05 &amp; 0.2 &amp; 0.199 ± 0.000 \\ \hline
500 &amp; 500 &amp; 1000 &amp; 0.1 &amp; 0.3 &amp; 0.05 &amp; 0.2 &amp; 0.198 ± 0.000 \\ \hline
500 &amp; 1000 &amp; 500 &amp; 1.0 &amp; 0.1 &amp; 0.05 &amp; 0.5 &amp; 0.488 ± 0.001 \\ \hline
\end{array}\]</span>
<p><span class="math display">\[\textbf{Table.} \text{ Re-estimated volatility for various sets of configurations}\]</span></p>
</div>
</div>
<details style="margin: 20px 0 20px 0;">
<summary style="
    cursor: pointer;
    padding: 8px 12px;
    background: #F1F3F5;
    font-weight: 600;
    color: #333333;
    border: none;
    border-radius: 4px;
    transition: all 0.2s ease;
">
Remark
</summary>
<div style="
    padding: 0px;
    margin-top: 12px;
    border-radius: 0 4px 4px 4px;
">
<p>Let’s verify the convergence of the second configuration for instance.</p>
<p><img src="report_files/figure-html/cell-34-output-2.png" class="img-fluid"></p>
</div>
</details>
</section>
</section>
<section id="appendix---the-quantlib-g2-class" class="level1">
<h1>Appendix - The QuantLib <code>G2</code> class</h1>
<hr>
<p>The goal of this section is to connect the equations from the Brigo-Mercurio book with the G2++ model implementation in QuantLib. The documentation for the QuantLib <code>G2 class</code> reference is available <a href="https://rkapl123.github.io/QLAnnotatedSource/dc/d85/class_quant_lib_1_1_g2.html">here</a>, and the source code can be found on <a href="https://github.com/lballabio/QuantLib/tree/master/ql/models/shortrate/twofactormodels">GitHub</a>. This directory mainly contains two key files:</p>
<ul>
<li><a href="https://github.com/lballabio/QuantLib/blob/master/ql/models/shortrate/twofactormodels/g2.hpp"><code>ql/models/shortrate/twofactormodels/g2.hpp</code></a> (Header file) <span class="math inline">\(-\)</span> Defines the class and its interface.</li>
<li><a href="https://github.com/lballabio/QuantLib/blob/master/ql/models/shortrate/twofactormodels/g2.cpp"><code>ql/models/shortrate/twofactormodels/g2.cpp</code></a> (Source file) <span class="math inline">\(-\)</span> Provides its implementation.</li>
</ul>
<section id="the-g2.hpp-file" class="level2">
<h2 class="anchored" data-anchor-id="the-g2.hpp-file">The <code>g2.hpp</code> file</h2>
<p>The <code>g2.hpp</code> file defines the G2++ model through the following structure.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> G2 </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Dynamics <span class="co">// Subclass representing the model's short rate dynamics</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        Dynamics<span class="op">()</span> <span class="co">// Constructor</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        shortRate<span class="op">()</span> <span class="co">// Computes the short rate at a given time</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> FittingParameter <span class="co">// Subclass handling term structure fitting</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        FittingParameter<span class="op">()</span> <span class="co">// Constructor</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">class</span> Impl <span class="co">// Subclass implementing fitting logic</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>            Impl<span class="op">()</span> <span class="co">// Constructor</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            value<span class="op">()</span> <span class="co">// Computes the fitted value for the term structure</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span><span class="op">:</span> </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        G2<span class="op">()</span> <span class="co">// Constructor</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        dynamics<span class="op">()</span> <span class="co">// Returns the short rate dynamics</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        discountBond<span class="op">()</span> <span class="co">// Computes the price of a zero-coupon bond</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        discountBondOption<span class="op">()</span> <span class="co">// Computes the price of a bond option via the Black formula</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        swaption<span class="op">()</span> <span class="co">// Computes the price of a swaption using numerical integration</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        a<span class="op">(),</span> sigma<span class="op">(),</span> b<span class="op">(),</span> eta<span class="op">(),</span> rho<span class="op">()</span> <span class="co">// Model parameters</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        discount<span class="op">()</span> <span class="co">// Computes the discount factor</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span><span class="op">:</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        generateArguments<span class="op">()</span> <span class="co">// Updates model parameters</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        A<span class="op">()</span> <span class="co">// Part of the analytical bond pricing formula</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        B<span class="op">()</span> <span class="co">// Part of the analytical bond pricing formula</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span><span class="op">:</span> </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        sigmaP<span class="op">()</span> <span class="co">// Computes volatility-related terms</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        V<span class="op">()</span> <span class="co">// Computes variance-related terms</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">a_</span><span class="op">,</span> <span class="va">sigma_</span><span class="op">,</span> <span class="va">b_</span><span class="op">,</span> <span class="va">eta_</span><span class="op">,</span> <span class="va">rho_</span> <span class="co">// Model parameters</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">phi_</span> <span class="co">// Additional fitting parameter</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">class</span> SwaptionPricingFunction <span class="co">// Utility class for swaption pricing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s take a closer look at the <code>Dynamics</code> and <code>FittingParameter</code> subclass.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>Dynamics class</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>First, the <code>Dynamics</code> subclass models the dynamics of the two processes <span class="math inline">\(\{x(t)\,:\,t\geq 0\}\)</span> and <span class="math inline">\(\{y(t)\,:\,t\geq 0\}\)</span> <span class="math display">\[\begin{equation*}
\begin{aligned}
dx(t) &amp;= -ax(t)dt + \sigma dW_1(t), \quad x(0) = 0, \\
dy(t) &amp;= -by(t)dt + \eta dW_2(t), \quad y(0) = 0,
\end{aligned}
\end{equation*}\]</span> where <span class="math display">\[dW_1(t)dW_2(t) = \rho dt,\]</span> Then, it incorporates the fitting function <span class="math inline">\(\varphi(t)\)</span> through the <code>fitting_</code> parameter. Finally, the <code>shortRate()</code> method calculates the short rate : <span class="math display">\[r(t) = \varphi(t) + x(t) + y(t)\]</span></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> G2<span class="op">::</span>Dynamics <span class="op">:</span> <span class="kw">public</span> TwoFactorModel<span class="op">::</span>ShortRateDynamics <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span><span class="op">:</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        Dynamics<span class="op">(</span>Parameter fitting<span class="op">,</span> Real a<span class="op">,</span> Real sigma<span class="op">,</span> Real b<span class="op">,</span> Real eta<span class="op">,</span> Real rho<span class="op">)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> ShortRateDynamics<span class="op">(</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                ext<span class="op">::</span>shared_ptr<span class="op">&lt;</span>StochasticProcess1D<span class="op">&gt;(</span><span class="kw">new</span> OrnsteinUhlenbeckProcess<span class="op">(</span>a<span class="op">,</span> sigma<span class="op">)),</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                ext<span class="op">::</span>shared_ptr<span class="op">&lt;</span>StochasticProcess1D<span class="op">&gt;(</span><span class="kw">new</span> OrnsteinUhlenbeckProcess<span class="op">(</span>b<span class="op">,</span> eta<span class="op">)),</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                rho<span class="op">),</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">fitting_</span><span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>fitting<span class="op">))</span> <span class="op">{}</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        Rate shortRate<span class="op">(</span>Time t<span class="op">,</span> Real x<span class="op">,</span> Real y<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">fitting_</span><span class="op">(</span>t<span class="op">)</span> <span class="op">+</span> x <span class="op">+</span> y<span class="op">;</span> <span class="op">}</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span><span class="op">:</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        Parameter <span class="va">fitting_</span><span class="op">;</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>FittingParameter class</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>First, the <code>value()</code> method calculates the variable <code>forward</code>, which represents the instantaneous forward rate at time <span class="math inline">\(0\)</span> for a maturity <span class="math inline">\(T\)</span> denoted by <span class="math inline">\(f^M(0,T)\)</span>. Then, it computes the variable <code>value</code>, which represents <span class="math display">\[\begin{equation*}
    \varphi(T) = \frac{\sigma^2}{2a^2}(1-e^{-aT})^2 + \frac{\eta^2}{2b^2}(1-e^{-bT})^2 + \rho\frac{\sigma \eta}{ab}(1-e^{-aT})(1-e^{-bT}) +  f^M(0,T)
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>Real value<span class="op">(</span><span class="at">const</span> Array<span class="op">&amp;,</span> Time t<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    Rate forward <span class="op">=</span> <span class="va">termStructure_</span><span class="op">-&gt;</span>forwardRate<span class="op">(</span>t<span class="op">,</span> t<span class="op">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                                                Continuous<span class="op">,</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                                                NoFrequency<span class="op">);</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    Real temp1 <span class="op">=</span> <span class="va">sigma_</span><span class="op">*(</span><span class="fl">1.0</span><span class="op">-</span><span class="bu">std::</span>exp<span class="op">(-</span><span class="va">a_</span><span class="op">*</span>t<span class="op">))/</span><span class="va">a_</span><span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    Real temp2 <span class="op">=</span> <span class="va">eta_</span><span class="op">*(</span><span class="fl">1.0</span><span class="op">-</span><span class="bu">std::</span>exp<span class="op">(-</span><span class="va">b_</span><span class="op">*</span>t<span class="op">))/</span><span class="va">b_</span><span class="op">;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    Real value <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>temp1<span class="op">*</span>temp1 <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>temp2<span class="op">*</span>temp2 <span class="op">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">rho_</span><span class="op">*</span>temp1<span class="op">*</span>temp2 <span class="op">+</span> forward<span class="op">;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="the-g2.cpp-file" class="level2">
<h2 class="anchored" data-anchor-id="the-g2.cpp-file">The <code>g2.cpp</code> file</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> G2</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    G2<span class="op">()</span> <span class="co">// Initializes parameters and computes phi_</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    dynamics<span class="op">()</span> <span class="co">// Returns the dynamics of the model (short rate dynamics)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    generateArguments<span class="op">()</span> <span class="co">// Computes the fitting parameter phi_</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    sigmaP<span class="op">()</span> <span class="co">// Computes volatility for option pricing</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    discountBond<span class="op">()</span> <span class="co">// Computes the price of a zero-coupon bond using analytical formulas</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    discountBondOption<span class="op">()</span> <span class="co">// Computes the price of a bond option using the Black formula</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    V<span class="op">()</span> <span class="co">// Computes the variance of the model</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    A<span class="op">(),</span> B<span class="op">()</span> <span class="co">// Analytical components for bond pricing</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Utility class for swaption pricing</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> SwaptionPricingFunction</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span><span class="op">:</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>            SwaptionPricingFunction<span class="op">()</span> <span class="co">// Initializes the pricing calculation parameters</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>            mux<span class="op">()</span> <span class="co">// Computes the mean for the swaption model</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            sigmax<span class="op">()</span> <span class="co">// Computes the volatility for the swaption model</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">operator</span><span class="op">()()</span> <span class="co">// Implements the pricing logic for the swaption</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">private</span><span class="op">:</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">class</span> SolvingFunction <span class="co">// Helper class to solve the implicit equation</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">public</span><span class="op">:</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                    SolvingFunction<span class="op">()</span> <span class="co">// Initializes the solving function parameters</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">operator</span><span class="op">()()</span> <span class="co">// Objective function for the solver (for swaption pricing)</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                <span class="kw">private</span><span class="op">:</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                    <span class="va">lambda_</span> <span class="co">// Auxiliary variable for the equation</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                    Bb_ <span class="co">// Auxiliary parameter for the equation</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">a_</span><span class="op">,</span> <span class="va">sigma_</span><span class="op">,</span> <span class="va">b_</span><span class="op">,</span> <span class="va">eta_</span><span class="op">,</span> <span class="va">rho_</span><span class="op">,</span> <span class="va">w_</span> <span class="co">// Model parameters</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        T_ <span class="co">// Maturity time of the instrument</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">t_</span> <span class="co">// Current time in the model</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">rate_</span> <span class="co">// Interest rate term structure</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">size_</span> <span class="co">// Size of the time grid for numerical integration</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        A_<span class="op">,</span> Ba_<span class="op">,</span> Bb_ <span class="co">// Bond pricing parameters</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">mux_</span><span class="op">,</span> <span class="va">muy_</span><span class="op">,</span> <span class="va">sigmax_</span><span class="op">,</span> <span class="va">sigmay_</span><span class="op">,</span> <span class="va">rhoxy_</span> <span class="co">// Parameters for swaption pricing model (mean, volatility, correlation)</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    swaption<span class="op">()</span> <span class="co">// Computes the price of a swaption using numerical integration</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>sigmaP()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>sigmaP()</code> implements the following formula from Theorem 4.2.2.:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
\Sigma(t,T,S)^2
=&amp;\: \frac{\sigma^2}{2a^3}\left[1-e^{-a(S-T)}\right]^2 \left[1-e^{-2a(T-t)}\right] \\
&amp; + \frac{\eta^2}{2b^3}\left[1-e^{-b(S-T)}\right]^2 \left[1-e^{-2b(T-t)}\right] \\
&amp; + 2\rho\frac{\sigma \eta}{ab(a+b)}\left[1-e^{-a(S-T)}\right]\left[1-e^{-b(S-T)}\right]\left[1-e^{-(a+b)(T-t)}\right]
\end{aligned}
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>sigmaP<span class="op">(</span>Time t<span class="op">,</span> Time s<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    Real temp <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-(</span>a<span class="op">()+</span>b<span class="op">())*</span>t<span class="op">);</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    Real temp1 <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span>a<span class="op">()*(</span>s<span class="op">-</span>t<span class="op">));</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    Real temp2 <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span>b<span class="op">()*(</span>s<span class="op">-</span>t<span class="op">));</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    Real a3 <span class="op">=</span> a<span class="op">()*</span>a<span class="op">()*</span>a<span class="op">();</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    Real b3 <span class="op">=</span> b<span class="op">()*</span>b<span class="op">()*</span>b<span class="op">();</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    Real sigma2 <span class="op">=</span> sigma<span class="op">()*</span>sigma<span class="op">();</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    Real eta2 <span class="op">=</span> eta<span class="op">()*</span>eta<span class="op">();</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    Real value <span class="op">=</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.5</span><span class="op">*</span>sigma2<span class="op">*</span>temp1<span class="op">*</span>temp1<span class="op">*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">2.0</span><span class="op">*</span>a<span class="op">()*</span>t<span class="op">))/</span>a3 <span class="op">+</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.5</span><span class="op">*</span>eta2<span class="op">*</span>temp2<span class="op">*</span>temp2<span class="op">*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">2.0</span><span class="op">*</span>b<span class="op">()*</span>t<span class="op">))/</span>b3 <span class="op">+</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="fl">2.0</span><span class="op">*</span>rho<span class="op">()*</span>sigma<span class="op">()*</span>eta<span class="op">()/(</span>a<span class="op">()*</span>b<span class="op">()*(</span>a<span class="op">()+</span>b<span class="op">()))*</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        temp1<span class="op">*</span>temp2<span class="op">*</span>temp<span class="op">;</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>sqrt<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>discountBond()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>discountBond()</code> implements the following formula:</p>
<p><span class="math display">\[\begin{equation}
P(t,T) = A(t,T)\exp\{-B(a,t,T)x(t) - B(b,t,T)y(t)\} \tag{4.15}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>discountBond<span class="op">(</span>Time t<span class="op">,</span> Time T<span class="op">,</span> Real x<span class="op">,</span> Real y<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> A<span class="op">(</span>t<span class="op">,</span>T<span class="op">)</span> <span class="op">*</span> <span class="bu">std::</span>exp<span class="op">(-</span>B<span class="op">(</span>a<span class="op">(),(</span>T<span class="op">-</span>t<span class="op">))*</span>x<span class="op">-</span>B<span class="op">(</span>b<span class="op">(),(</span>T<span class="op">-</span>t<span class="op">))*</span>y<span class="op">);</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>discountBondOption()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>discountBondOption()</code> implements the following formula:</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
&amp;\mathbf{ZBC}(t,T,S,K) \\
&amp;= P(t,S)\Phi\left(\frac{\ln \frac{P(t,S)}{KP(t,T)}}{\Sigma(t,T,S)} + \frac{1}{2}\Sigma(t,T,S)\right)
- P(t,T)K\Phi\left(\frac{\ln\frac{P(t,S)}{KP(t,T)}}{\Sigma(t,T,S)} - \frac{1}{2}\Sigma(t,T,S)\right)
\end{aligned}
\tag{4.21}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>discountBondOption<span class="op">(</span>Option<span class="op">::</span>Type type<span class="op">,</span> Real strike<span class="op">,</span> Time maturity<span class="op">,</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    Time bondMaturity<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    Real v <span class="op">=</span> sigmaP<span class="op">(</span>maturity<span class="op">,</span> bondMaturity<span class="op">);</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    Real f <span class="op">=</span> termStructure<span class="op">()-&gt;</span>discount<span class="op">(</span>bondMaturity<span class="op">);</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    Real k <span class="op">=</span> termStructure<span class="op">()-&gt;</span>discount<span class="op">(</span>maturity<span class="op">)*</span>strike<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> blackFormula<span class="op">(</span>type<span class="op">,</span> k<span class="op">,</span> f<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>V()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>V()</code> implements the following formula:</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
V(t,T)
=&amp;\:\frac{\sigma^2}{a^2}\left[T-t + \frac{2}{a}e^{-a(T-t)} - \frac{1}{2a}e^{-2a(T-t)} - \frac{3}{2a}\right] \\
&amp;+\frac{\eta^2}{b^2}\left[T-t + \frac{2}{b}e^{-b(T-t)} - \frac{1}{2b}e^{-2b(T-t)} - \frac{3}{2b}\right] \\
&amp;+2\rho \frac{\sigma\eta}{ab}\left[T-t+\frac{e^{-a(T-t)}-1}{a} + \frac{e^{-b(T-t)}-1}{b} - \frac{e^{-(a+b)(T-t)}-1}{a+b}\right]
\end{aligned}
\tag{4.10}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>V<span class="op">(</span>Time t<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    Real expat <span class="op">=</span> <span class="bu">std::</span>exp<span class="op">(-</span>a<span class="op">()*</span>t<span class="op">);</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    Real expbt <span class="op">=</span> <span class="bu">std::</span>exp<span class="op">(-</span>b<span class="op">()*</span>t<span class="op">);</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    Real cx <span class="op">=</span> sigma<span class="op">()/</span>a<span class="op">();</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    Real cy <span class="op">=</span> eta<span class="op">()/</span>b<span class="op">();</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    Real valuex <span class="op">=</span> cx<span class="op">*</span>cx<span class="op">*(</span>t <span class="op">+</span> <span class="op">(</span><span class="fl">2.0</span><span class="op">*</span>expat<span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>expat<span class="op">*</span>expat<span class="op">-</span><span class="fl">1.5</span><span class="op">)/</span>a<span class="op">());</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    Real valuey <span class="op">=</span> cy<span class="op">*</span>cy<span class="op">*(</span>t <span class="op">+</span> <span class="op">(</span><span class="fl">2.0</span><span class="op">*</span>expbt<span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>expbt<span class="op">*</span>expbt<span class="op">-</span><span class="fl">1.5</span><span class="op">)/</span>b<span class="op">());</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    Real value <span class="op">=</span> <span class="fl">2.0</span><span class="op">*</span>rho<span class="op">()*</span>cx<span class="op">*</span>cy<span class="op">*</span> <span class="op">(</span>t <span class="op">+</span> <span class="op">(</span>expat <span class="op">-</span> <span class="fl">1.0</span><span class="op">)/</span>a<span class="op">()</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="op">+</span> <span class="op">(</span>expbt <span class="op">-</span> <span class="fl">1.0</span><span class="op">)/</span>b<span class="op">()</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="op">-</span> <span class="op">(</span>expat<span class="op">*</span>expbt<span class="op">-</span><span class="fl">1.0</span><span class="op">)/(</span>a<span class="op">()+</span>b<span class="op">()));</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> valuex <span class="op">+</span> valuey <span class="op">+</span> value<span class="op">;</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>A()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>A()</code> implements the following formula:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
A(t,T)=\frac{P^M(0,T)}{P^M(0,t)}\exp\left\{\frac{1}{2}[V(t,T)-V(0,T)+V(0,t)]\right\}
\end{aligned}
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>A<span class="op">(</span>Time t<span class="op">,</span> Time T<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> termStructure<span class="op">()-&gt;</span>discount<span class="op">(</span>T<span class="op">)/</span>termStructure<span class="op">()-&gt;</span>discount<span class="op">(</span>t<span class="op">)*</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>exp<span class="op">(</span><span class="fl">0.5</span><span class="op">*(</span>V<span class="op">(</span>T<span class="op">-</span>t<span class="op">)</span> <span class="op">-</span> V<span class="op">(</span>T<span class="op">)</span> <span class="op">+</span> V<span class="op">(</span>t<span class="op">)));</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>B()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>B()</code> implements the following formula:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
B(t,T)=\frac{1-e^{-z(T-t)}}{z}
\end{aligned}
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>B<span class="op">(</span>Real x<span class="op">,</span> Time t<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span>x<span class="op">*</span>t<span class="op">))/</span>x<span class="op">;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>SwaptionPricingFunction()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>SwaptionPricingFunction()</code> implements the following formula from Theorem 4.2.3.:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
\mu_x&amp;:=-M_x^T(0,T) \\
\mu_y&amp;:=-M_y^T(0,T) \\
\sigma_x &amp;:= \sigma\sqrt{\frac{1-e^{-2aT}}{2a}} \\
\sigma_y &amp;:= \eta\sqrt{\frac{1-e^{-2bT}}{2b}} \\
\rho_{xy} &amp;:= \frac{\rho \sigma \eta}{(a+b)\sigma_x\sigma_y}\left[1-e^{-(a+b)T}\right]
\end{aligned}
\end{equation*}\]</span> and from Lemma 4.2.2.: <span class="math display">\[\begin{equation*}
\begin{aligned}
M_x^T(s,t)&amp;:=\left(\frac{\sigma^2}{a^2}+\rho\frac{\sigma\eta}{ab}\right)\left[1-e^{-a(t-s)}\right] - \frac{\sigma^2}{2a^2}\left[e^{-a(T-t)}-e^{-a(T+t-2s)}\right] - \frac{\rho \sigma \eta}{b(a+b)}\left[e^{-b(T-t)} - e^{-bT-at+(a+b)s}\right] \\
M_y^T(s,t)&amp;:=\left(\frac{\eta^2}{b^2}+\rho\frac{\sigma\eta}{ab}\right)\left[1-e^{-b(t-s)}\right] - \frac{\eta^2}{2b^2}\left[e^{-b(T-t)}-e^{-b(T+t-2s)}\right] - \frac{\rho \sigma \eta}{a(a+b)}\left[e^{-a(T-t)} - e^{-aT-bt+(a+b)s}\right] \\
\end{aligned}
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>SwaptionPricingFunction<span class="op">(</span>Real a<span class="op">,</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                        Real sigma<span class="op">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                        Real b<span class="op">,</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                        Real eta<span class="op">,</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                        Real rho<span class="op">,</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                        Real w<span class="op">,</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                        Real start<span class="op">,</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">std::</span>vector<span class="op">&lt;</span>Time<span class="op">&gt;</span> payTimes<span class="op">,</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                        Rate fixedRate<span class="op">,</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">const</span> G2<span class="op">&amp;</span> model<span class="op">)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="op">:</span> <span class="va">a_</span><span class="op">(</span>a<span class="op">),</span> <span class="va">sigma_</span><span class="op">(</span>sigma<span class="op">),</span> <span class="va">b_</span><span class="op">(</span>b<span class="op">),</span> <span class="va">eta_</span><span class="op">(</span>eta<span class="op">),</span> <span class="va">rho_</span><span class="op">(</span>rho<span class="op">),</span> <span class="va">w_</span><span class="op">(</span>w<span class="op">),</span> T_<span class="op">(</span>start<span class="op">),</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">t_</span><span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>payTimes<span class="op">)),</span> <span class="va">rate_</span><span class="op">(</span>fixedRate<span class="op">),</span> <span class="va">size_</span><span class="op">(</span><span class="va">t_</span><span class="op">.</span>size<span class="op">()),</span> A_<span class="op">(</span><span class="va">size_</span><span class="op">),</span> Ba_<span class="op">(</span><span class="va">size_</span><span class="op">),</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  Bb_<span class="op">(</span><span class="va">size_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">sigmax_</span> <span class="op">=</span> <span class="va">sigma_</span><span class="op">*</span><span class="bu">std::</span>sqrt<span class="op">(</span><span class="fl">0.5</span><span class="op">*(</span><span class="fl">1.0</span><span class="op">-</span><span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">2.0</span><span class="op">*</span><span class="va">a_</span><span class="op">*</span>T_<span class="op">))/</span><span class="va">a_</span><span class="op">);</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">sigmay_</span> <span class="op">=</span>   <span class="va">eta_</span><span class="op">*</span><span class="bu">std::</span>sqrt<span class="op">(</span><span class="fl">0.5</span><span class="op">*(</span><span class="fl">1.0</span><span class="op">-</span><span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">2.0</span><span class="op">*</span><span class="va">b_</span><span class="op">*</span>T_<span class="op">))/</span><span class="va">b_</span><span class="op">);</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">rhoxy_</span> <span class="op">=</span> <span class="va">rho_</span><span class="op">*</span><span class="va">eta_</span><span class="op">*</span><span class="va">sigma_</span><span class="op">*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-(</span><span class="va">a_</span><span class="op">+</span><span class="va">b_</span><span class="op">)*</span>T_<span class="op">))/</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">((</span><span class="va">a_</span><span class="op">+</span><span class="va">b_</span><span class="op">)*</span><span class="va">sigmax_</span><span class="op">*</span><span class="va">sigmay_</span><span class="op">);</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    Real temp <span class="op">=</span> <span class="va">sigma_</span><span class="op">*</span><span class="va">sigma_</span><span class="op">/(</span><span class="va">a_</span><span class="op">*</span><span class="va">a_</span><span class="op">);</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="va">mux_</span> <span class="op">=</span> <span class="op">-((</span>temp<span class="op">+</span><span class="va">rho_</span><span class="op">*</span><span class="va">sigma_</span><span class="op">*</span><span class="va">eta_</span><span class="op">/(</span><span class="va">a_</span><span class="op">*</span><span class="va">b_</span><span class="op">))*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span>a<span class="op">*</span>T_<span class="op">))</span> <span class="op">-</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.5</span><span class="op">*</span>temp<span class="op">*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">2.0</span><span class="op">*</span><span class="va">a_</span><span class="op">*</span>T_<span class="op">))</span> <span class="op">-</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                <span class="va">rho_</span><span class="op">*</span><span class="va">sigma_</span><span class="op">*</span><span class="va">eta_</span><span class="op">/(</span><span class="va">b_</span><span class="op">*(</span><span class="va">a_</span><span class="op">+</span><span class="va">b_</span><span class="op">))*</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-(</span><span class="va">b_</span><span class="op">+</span><span class="va">a_</span><span class="op">)*</span>T_<span class="op">)));</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> <span class="va">eta_</span><span class="op">*</span><span class="va">eta_</span><span class="op">/(</span><span class="va">b_</span><span class="op">*</span><span class="va">b_</span><span class="op">);</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="va">muy_</span> <span class="op">=</span> <span class="op">-((</span>temp<span class="op">+</span><span class="va">rho_</span><span class="op">*</span><span class="va">sigma_</span><span class="op">*</span><span class="va">eta_</span><span class="op">/(</span><span class="va">a_</span><span class="op">*</span><span class="va">b_</span><span class="op">))*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span>b<span class="op">*</span>T_<span class="op">))</span> <span class="op">-</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.5</span><span class="op">*</span>temp<span class="op">*(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">2.0</span><span class="op">*</span><span class="va">b_</span><span class="op">*</span>T_<span class="op">))</span> <span class="op">-</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>                <span class="va">rho_</span><span class="op">*</span><span class="va">sigma_</span><span class="op">*</span><span class="va">eta_</span><span class="op">/(</span><span class="va">a_</span><span class="op">*(</span><span class="va">a_</span><span class="op">+</span><span class="va">b_</span><span class="op">))*</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-(</span><span class="va">b_</span><span class="op">+</span><span class="va">a_</span><span class="op">)*</span>T_<span class="op">)));</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Size i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span><span class="va">size_</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        A_<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> model<span class="op">.</span>A<span class="op">(</span>T_<span class="op">,</span> <span class="va">t_</span><span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        Ba_<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> model<span class="op">.</span>B<span class="op">(</span><span class="va">a_</span><span class="op">,</span> <span class="va">t_</span><span class="op">[</span>i<span class="op">]-</span>T_<span class="op">);</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        Bb_<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> model<span class="op">.</span>B<span class="op">(</span><span class="va">b_</span><span class="op">,</span> <span class="va">t_</span><span class="op">[</span>i<span class="op">]-</span>T_<span class="op">);</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>operator()()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>operator()()</code> implements the following formula from Theorem 4.2.3.. We denote by <span class="math inline">\(\tau_i\)</span> the year fraction from <span class="math inline">\(t_{i-1}\)</span> to <span class="math inline">\(t_i\)</span>, <span class="math inline">\(i=1,\dots,n\)</span> and set <span class="math inline">\(c_i:=X\tau_i\)</span> for <span class="math inline">\(i=1,\dots,n-1\)</span> abd <span class="math inline">\(c_n:=1+X\tau_n\)</span>.</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
    &amp;\textcolor{gray}{\mathbf{ES}(0,T,\mathcal{T},N,X,\omega)} \\
    &amp;= \textcolor{gray}{N\omega P(0,T)\int_{-\infty}^{+\infty}} \frac{e^{-\frac{1}{2}(\frac{x-\mu_x}{\sigma_x})^2}}{\sigma_x\sqrt{2\pi}} \left[\Phi(-\omega h_1(x)) - \sum_{i=1}^n \lambda_i(x)e^{\kappa_i(x)}\Phi(-\omega h_2(x))\right]\textcolor{gray}{dx},
\end{aligned}
\tag{4.31}
\end{equation}\]</span> where <span class="math inline">\(\omega=1\)</span> (<span class="math inline">\(\omega=-1\)</span>) for a payer (receiver) swaption, <span class="math display">\[\begin{equation*}
\begin{aligned}
h_1(x)&amp;:=\frac{\overline{y}-\mu_y}{\sigma_y\sqrt{1-\rho_{xy}^2}} - \frac{\rho_{xy}(x-\mu_x)}{\sigma_x\sqrt{1-\rho_{xy}^2}} \\
h_2(x)&amp;:=h_1(x) + B(b,T,t_i)\sigma_y\sqrt{1-\rho_{xy}^2} \\
\lambda_i(x)&amp;:=c_iA(T,t_i)e^{-B(a,T,t_i)x} \\
\kappa_i(x)&amp;:=-B(b,T,t_i)\left[\mu_y-\frac{1}{2}(1-\rho_{xy}^2)\sigma^2_yB(b,T,t_i) + \rho_{xy}\sigma_y\frac{x-\mu_x}{\sigma_x}\right]
\end{aligned}
\end{equation*}\]</span> <span class="math inline">\(\overline{y}=\overline{y}(x)\)</span> is the unique solution of the following equation <span class="math display">\[\sum_{i=1}^n c_iA(T,t_i)e^{-B(a,T,t_i)x -B(b,T,t_i)\overline{y}}=1\]</span></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>Real <span class="kw">operator</span><span class="op">()(</span>Real x<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    CumulativeNormalDistribution phi<span class="op">;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    Real temp <span class="op">=</span> <span class="op">(</span>x <span class="op">-</span> <span class="va">mux_</span><span class="op">)/</span><span class="va">sigmax_</span><span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    Real txy <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="va">rhoxy_</span><span class="op">*</span><span class="va">rhoxy_</span><span class="op">);</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    Array lambda<span class="op">(</span><span class="va">size_</span><span class="op">);</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    Size i<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span><span class="va">size_</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        Real tau <span class="op">=</span> <span class="op">(</span>i<span class="op">==</span><span class="dv">0</span> <span class="op">?</span> <span class="va">t_</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T_ <span class="op">:</span> <span class="va">t_</span><span class="op">[</span>i<span class="op">]</span> <span class="op">-</span> <span class="va">t_</span><span class="op">[</span>i<span class="op">-</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        Real c <span class="op">=</span> <span class="op">(</span>i<span class="op">==</span><span class="va">size_</span><span class="op">-</span><span class="dv">1</span> <span class="op">?</span> Real<span class="op">(</span><span class="fl">1.0</span><span class="op">+</span><span class="va">rate_</span><span class="op">*</span>tau<span class="op">)</span> <span class="op">:</span> <span class="va">rate_</span><span class="op">*</span>tau<span class="op">);</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        lambda<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> c<span class="op">*</span>A_<span class="op">[</span>i<span class="op">]*</span><span class="bu">std::</span>exp<span class="op">(-</span>Ba_<span class="op">[</span>i<span class="op">]*</span>x<span class="op">);</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    SolvingFunction function<span class="op">(</span>lambda<span class="op">,</span> Bb_<span class="op">)</span> <span class="op">;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    Brent s1d<span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    s1d<span class="op">.</span>setMaxEvaluations<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    Real searchBound <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span><span class="fl">10.0</span><span class="op">*</span><span class="va">sigmay_</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    Real yb <span class="op">=</span> s1d<span class="op">.</span>solve<span class="op">(</span>function<span class="op">,</span> <span class="fl">1e-6</span><span class="op">,</span> <span class="fl">0.00</span><span class="op">,</span> <span class="op">-</span>searchBound<span class="op">,</span> searchBound<span class="op">);</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    Real h1 <span class="op">=</span> <span class="op">(</span>yb <span class="op">-</span> <span class="va">muy_</span><span class="op">)/(</span><span class="va">sigmay_</span><span class="op">*</span>txy<span class="op">)</span> <span class="op">-</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">rhoxy_</span><span class="op">*(</span>x  <span class="op">-</span> <span class="va">mux_</span><span class="op">)/(</span><span class="va">sigmax_</span><span class="op">*</span>txy<span class="op">);</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    Real value <span class="op">=</span> phi<span class="op">(-</span><span class="va">w_</span><span class="op">*</span>h1<span class="op">);</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span><span class="va">size_</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        Real h2 <span class="op">=</span> h1 <span class="op">+</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>            Bb_<span class="op">[</span>i<span class="op">]*</span><span class="va">sigmay_</span><span class="op">*</span><span class="bu">std::</span>sqrt<span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">rhoxy_</span><span class="op">*</span><span class="va">rhoxy_</span><span class="op">);</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        Real kappa <span class="op">=</span> <span class="op">-</span> Bb_<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span><span class="va">muy_</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span>txy<span class="op">*</span>txy<span class="op">*</span><span class="va">sigmay_</span><span class="op">*</span><span class="va">sigmay_</span><span class="op">*</span>Bb_<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>                <span class="va">rhoxy_</span><span class="op">*</span><span class="va">sigmay_</span><span class="op">*(</span>x<span class="op">-</span><span class="va">mux_</span><span class="op">)/</span><span class="va">sigmax_</span><span class="op">);</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        value <span class="op">-=</span> lambda<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span><span class="bu">std::</span>exp<span class="op">(</span>kappa<span class="op">)*</span>phi<span class="op">(-</span><span class="va">w_</span><span class="op">*</span>h2<span class="op">);</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>exp<span class="op">(-</span><span class="fl">0.5</span><span class="op">*</span>temp<span class="op">*</span>temp<span class="op">)*</span>value<span class="op">/</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="va">sigmax_</span><span class="op">*</span><span class="bu">std::</span>sqrt<span class="op">(</span><span class="fl">2.0</span><span class="op">*</span>M_PI<span class="op">));</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>SolvingFunction<span class="op">(</span><span class="at">const</span> Array<span class="op">&amp;</span> lambda<span class="op">,</span> <span class="at">const</span> Array<span class="op">&amp;</span> Bb<span class="op">)</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="op">:</span> <span class="va">lambda_</span><span class="op">(</span>lambda<span class="op">),</span> Bb_<span class="op">(</span>Bb<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>Real <span class="kw">operator</span><span class="op">()(</span>Real y<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    Real value <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Size i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span><span class="va">lambda_</span><span class="op">.</span>size<span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>        value <span class="op">-=</span> <span class="va">lambda_</span><span class="op">[</span>i<span class="op">]*</span><span class="bu">std::</span>exp<span class="op">(-</span>Bb_<span class="op">[</span>i<span class="op">]*</span>y<span class="op">);</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>swaption()</code> function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>swaption()</code> implements the following formula from Theorem 4.2.3.. The integral is approximated numerically. The parameter <code>range</code> specifies the integration bounds in terms of the standard deviation of <span class="math inline">\(\sigma_x\)</span>, indicating how many standard deviations are considered for the integral. The integration range is given by <span class="math inline">\([\)</span><code>lower</code><span class="math inline">\(,\)</span> <code>upper</code><span class="math inline">\(]
= [\mu_x -\)</span> <code>range</code> <span class="math inline">\(\times \sigma_x\)</span>, <span class="math inline">\(\mu_x +\)</span> <code>range</code> <span class="math inline">\(\times \sigma_x]\)</span>.</p>
<p>The <code>intervals</code> splits this range into <code>intervals</code> smaller steps to approximate the value of the integral.</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
    &amp;\mathbf{ES}(0,T,\mathcal{T},N,X,\omega) \\
    &amp;= N\omega P(0,T)\int_{-\infty}^{+\infty} \textcolor{gray}{\frac{e^{-\frac{1}{2}(\frac{x-\mu_x}{\sigma_x})^2}}{\sigma_x\sqrt{2\pi}} \left[\Phi(-\omega h_1(x)) - \sum_{i=1}^n \lambda_i(x)e^{\kappa_i(x)}\Phi(-\omega h_2(x))\right]}dx
\end{aligned}
\tag{4.31}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>Real G2<span class="op">::</span>swaption<span class="op">(</span><span class="at">const</span> Swaption<span class="op">::</span>arguments<span class="op">&amp;</span> arguments<span class="op">,</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                  Rate fixedRate<span class="op">,</span> Real range<span class="op">,</span> Size intervals<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    QL_REQUIRE<span class="op">(</span>arguments<span class="op">.</span>nominal <span class="op">!=</span> Null<span class="op">&lt;</span>Real<span class="op">&gt;(),</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"non-constant nominals are not supported yet"</span><span class="op">);</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    Date settlement <span class="op">=</span> termStructure<span class="op">()-&gt;</span>referenceDate<span class="op">();</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    DayCounter dayCounter <span class="op">=</span> termStructure<span class="op">()-&gt;</span>dayCounter<span class="op">();</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    Time start <span class="op">=</span> dayCounter<span class="op">.</span>yearFraction<span class="op">(</span>settlement<span class="op">,</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>                                            arguments<span class="op">.</span>floatingResetDates<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    Real w <span class="op">=</span> <span class="op">(</span>arguments<span class="op">.</span>type<span class="op">==</span>Swap<span class="op">::</span>Payer <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span> <span class="op">);</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span>Time<span class="op">&gt;</span> fixedPayTimes<span class="op">(</span>arguments<span class="op">.</span>fixedPayDates<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Size i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>fixedPayTimes<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>        fixedPayTimes<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>            dayCounter<span class="op">.</span>yearFraction<span class="op">(</span>settlement<span class="op">,</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>                                    arguments<span class="op">.</span>fixedPayDates<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    SwaptionPricingFunction function<span class="op">(</span>a<span class="op">(),</span> sigma<span class="op">(),</span> b<span class="op">(),</span> eta<span class="op">(),</span> rho<span class="op">(),</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                                        w<span class="op">,</span> start<span class="op">,</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                                        fixedPayTimes<span class="op">,</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                                        fixedRate<span class="op">,</span> <span class="op">(*</span><span class="kw">this</span><span class="op">));</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    Real upper <span class="op">=</span> function<span class="op">.</span>mux<span class="op">()</span> <span class="op">+</span> range<span class="op">*</span>function<span class="op">.</span>sigmax<span class="op">();</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    Real lower <span class="op">=</span> function<span class="op">.</span>mux<span class="op">()</span> <span class="op">-</span> range<span class="op">*</span>function<span class="op">.</span>sigmax<span class="op">();</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    SegmentIntegral integrator<span class="op">(</span>intervals<span class="op">);</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arguments<span class="op">.</span>nominal <span class="op">*</span> w <span class="op">*</span> termStructure<span class="op">()-&gt;</span>discount<span class="op">(</span>start<span class="op">)</span> <span class="op">*</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        integrator<span class="op">(</span>function<span class="op">,</span> lower<span class="op">,</span> upper<span class="op">);</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-black1991bond" class="csl-entry" role="listitem">
Black, Fischer, and Piotr Karasinski. 1991. <span>“Bond and Option Pricing When Short Rates Are Lognormal.”</span> <a href="https://roycheng.cn/files/papers/interestRate/paper_Black&amp;Karasinski_1991.pdf">https://roycheng.cn/files/papers/interestRate/paper_Black&amp;Karasinski_1991.pdf</a>.
</div>
<div id="ref-brigo2001interest" class="csl-entry" role="listitem">
Brigo, Damiano, and Fabio Mercurio. 2001. <em>Interest Rate Models: Theory and Practice</em>. Springer.
</div>
<div id="ref-dubrana2009calibration" class="csl-entry" role="listitem">
Dubrana, Ludovic. 2009. <span>“Calibration of Credit Spread Scenarios for Monte Carlo Simulations.”</span> <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2083625">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2083625</a>.
</div>
<div id="ref-karasinski2021black" class="csl-entry" role="listitem">
Karasinski, Piotr, and Colin Turfus. 2021. <span>“The Black-Karasinski Model: Thirty Years On.”</span> <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3827452">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3827452</a>.
</div>
<div id="ref-khan2008short" class="csl-entry" role="listitem">
Khan, Aisha, Eric Guan, and Ser-Huang Poon. 2008. <span>“Short Rate Models: Hull-White or Black-Karasinski? Implementation Note and Model Comparison for ALM.”</span> Manchester Business School Working Paper. <a href="https://www.econstor.eu/bitstream/10419/50684/1/584765029.pdf">https://www.econstor.eu/bitstream/10419/50684/1/584765029.pdf</a>.
</div>
<div id="ref-kima2014portfolio" class="csl-entry" role="listitem">
Kima, Richard. 2014. <span>“Portfolio Market and Credit Risks Aggregaton Using Economic Scenarios Generators and Student t-Copulae.”</span> <a href="https://www.diva-portal.org/smash/get/diva2:738296/FULLTEXT01.pdf">https://www.diva-portal.org/smash/get/diva2:738296/FULLTEXT01.pdf</a>.
</div>
<div id="ref-svoboda2003interest" class="csl-entry" role="listitem">
Svoboda, Simona. 2004. <em>Interest Rate Modelling</em>. Springer.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>
